<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeless Whispers</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900&family=Lora:ital,wght@0,400..700;1,400..700&family=Raleway:wght@300;400;500&family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { 
        getAuth, 
        GoogleAuthProvider, 
        signInWithPopup, 
        signOut, 
        onAuthStateChanged,
        signInWithCustomToken,
        signInAnonymously
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { 
        getFirestore, 
        collection, 
        addDoc, 
        query, 
        where, 
        getDocs, 
        doc, 
        getDoc, 
        setDoc, 
        serverTimestamp, 
        updateDoc, 
        arrayUnion,
        onSnapshot,
        arrayRemove,
        deleteDoc,
        orderBy
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Your web app's Firebase configuration
      // *** THIS IS YOUR LIVE, PUBLIC CONFIGURATION ***
      // NOTE: This config is slightly different from the user's.
      // We will use the __firebase_config global variable provided by the environment.
      // And we will use the __app_id global variable.
      // And we will use the __initial_auth_token global variable.

      let firebaseConfig;
      let appId;

      // Use environment variables if available, otherwise fall back to user's config
      if (typeof __firebase_config !== 'undefined') {
          firebaseConfig = JSON.parse(__firebase_config);
          appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
          console.log("Using environment Firebase config.");
      } else {
          console.warn("Using fallback Firebase config. This may not work with production security rules.");
          firebaseConfig = {
            apiKey: "AIzaSyCsufbKfJcNZ40aDXDNXgHI-QphkFmXi-0",
            authDomain: "timelesswhispers-37f98.firebaseapp.com",
            projectId: "timelesswhispers-37f98",
            storageBucket: "timelesswhispers-37f98.firebasestorage.app",
            messagingSenderId: "632234683017",
            appId: "1:632234683017:web:04f44be51fa2f88075b458",
            measurementId: "G-PLN3R3YSCX"
          };
          appId = firebaseConfig.appId; // Use appId from fallback config
      }


      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- PAGE SCRIPT ---
      document.addEventListener('DOMContentLoaded', () => {
        
        // --- Collection References ---
        // Use the environment-aware appId
        const poemsColRef = collection(db, "artifacts", appId, "public", "data", "poems");
        const commentsColRef = collection(db, "artifacts", appId, "public", "data", "comments");
        const usersColRef = collection(db, "artifacts", appId, "users");
        // New reference for the categories document
        const categoriesDocRef = doc(db, "artifacts", appId, "public", "data", "siteState", "categories");

        
        // --- DATA & CONSTANTS ---
        const defaultCategories = ['All', 'Favorites', 'Love', 'Loss', 'Hope', 'Healing', 'Chaos', 'Silent Nights', 'Red Verse'];
        
        // --- STATE MANAGEMENT ---
        let currentTheme = 'light';
        let activeFilter = 'All';
        let categories = [...defaultCategories]; // This will be filled from Firestore
        let favoritePoemIds = []; // Stores Firebase doc IDs (strings)
        let currentOpenPoemId = null; // Stores Firebase doc ID (string)
        let allPoems = []; // This will be filled from Firestore
        let currentUserId = null;
        let adminListeners = []; // To store admin onSnapshot listeners
        let poemFormEditId = null; // Stores ID of poem being edited
        let userFavoritesUnsubscribe = null; // To unsubscribe from user's favorites
        let hasLoadedInitialData = false; // FIX: Flag to prevent re-loading data on auth flicker
        let commentsUnsubscribe = null; // To store the onSnapshot listener

        // --- DOM ELEMENTS ---
        const docElement = document.documentElement;
        const body = document.body;
        const topNav = document.getElementById('top-nav');
        const categoryFiltersContainer = document.getElementById('category-filters'); // Renamed
        const poemsGrid = document.getElementById('poems-grid');
        const modal = document.getElementById('quick-preview-modal');
        const modalContent = document.getElementById('modal-poem-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const themeToggleButton = document.getElementById('theme-toggle');
        const heroSection = document.getElementById('about'); // For Red Verse
        
        // Auth DOM Elements
        const navAuth = document.getElementById('nav-auth');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userName = document.getElementById('user-name');
        
        // Admin Panel DOM Elements
        const adminSection = document.getElementById('admin');
        const adminLink = document.getElementById('admin-link');
        const poemForm = document.getElementById('poem-form'); 
        const statusMessage = document.getElementById('status-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const adminTabs = document.querySelectorAll('.admin-tab');
        const adminTabContents = document.querySelectorAll('.admin-tab-content');
        const addEditPoemTab = document.querySelector('[data-tab="add-edit-poem"]');
        const poemFormTitle = document.getElementById('poem-form-title');
        const submitBtn = document.getElementById('submit-btn');
        const poemEmotionSelect = document.getElementById('poem-emotion');
        const newCategoryInput = document.getElementById('new-category-input');
        const addCategoryBtn = document.getElementById('add-category-btn');
        
        // Admin Data Lists
        const adminPoemList = document.getElementById('admin-poem-list');
        const adminCommentList = document.getElementById('admin-comment-list');
        const adminReviewList = document.getElementById('admin-review-list');
        const adminSubmissionList = document.getElementById('admin-submission-list');
        
        // Admin Stats
        const statTotalPoems = document.getElementById('stat-total-poems');
        const statTotalComments = document.getElementById('stat-total-comments');
        const statTotalUsers = document.getElementById('stat-total-users');

        // Red Verse Modal DOM Elements
        const redVerseModal = document.getElementById('red-verse-modal');
        const redVerseCloseBtn = document.getElementById('red-verse-close-btn');
        const redVerseCancelBtn = document.getElementById('red-verse-cancel-btn');
        const redVerseSubmitBtn = document.getElementById('red-verse-submit-btn');
        const redVersePasswordInput = document.getElementById('red-verse-password');
        const redVerseError = document.getElementById('red-verse-error');


        // --- SVG ICONS ---
        const SunIcon = `<svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m4.93 19.07 1.41-1.41"></path><path d="m17.66 6.34 1.41-1.41"></path></svg>`;
        const MoonIcon = `<svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>`;
        const HeartIconOutline = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>`;
        const HeartIconFilled = `<svg class="w-6 h-6 heart-filled" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>`;
        const ShareIcon = `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>`;

        // --- RENDER FUNCTIONS ---

        // New function to seed categories if they don't exist
        async function seedCategoriesIfNeeded() {
            try {
                const docSnap = await getDoc(categoriesDocRef);
                if (!docSnap.exists()) {
                    console.log("No categories doc found, seeding...");
                    await setDoc(categoriesDocRef, { list: defaultCategories });
                    categories = [...defaultCategories];
                } else {
                    // Load categories from Firestore
                    categories = docSnap.data().list || [...defaultCategories];
                }
            } catch (error) {
                console.error("Error seeding or checking categories:", error);
                categories = [...defaultCategories]; // Fallback
            }
        }

        // New function to load categories from Firestore
        function loadCategories() {
            onSnapshot(categoriesDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    categories = docSnap.data().list || [...defaultCategories];
                } else {
                    // Doc doesn't exist, seed it
                    seedCategoriesIfNeeded(); // This will also update the 'categories' variable
                }
                
                // Once categories are loaded/updated, re-render the UI
                renderCategoryFilters();
                renderAdminCategorySelect();
            }, (error) => {
                console.error("Error listening to categories:", error);
                // Fallback to defaults if listener fails
                categories = [...defaultCategories];
                renderCategoryFilters();
                renderAdminCategorySelect();
            });
        }
        
        // Renamed and updated to use dynamic 'categories'
        function renderCategoryFilters() {
            if (!categoryFiltersContainer) return;
            categoryFiltersContainer.innerHTML = categories.map(category => `
                <button data-filter="${category}" class="filter-btn py-2 px-5 rounded-full text-sm transition-all duration-300 ${activeFilter === category ? 'active text-[var(--c-bg)]' : 'border'}" style="${activeFilter === category ? `background-color: var(--c-accent-1); border-color: var(--c-accent-1);` : `border-color: var(--c-accent-2); color: var(--c-text);`}">
                    ${category}
                </button>
            `).join('');
            
            categoryFiltersContainer.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const filter = btn.dataset.filter;
                    
                    if (filter === 'Red Verse') {
                        // Show the password modal instead of filtering
                        redVersePasswordInput.value = "";
                        redVerseError.classList.add('hidden');
                        redVerseModal.classList.add('visible');
                    } else {
                        // Handle other filters normally
                        clearRedVerseTheme();
                        activeFilter = filter;
                        renderCategoryFilters();
                        renderPoemsGrid();
                    }
                });
            });
        }

        // New function to populate the admin category dropdown
        function renderAdminCategorySelect() {
            if (!poemEmotionSelect) return;
            
            const currentValue = poemEmotionSelect.value;
            poemEmotionSelect.innerHTML = `<option value="">Select a category...</option>`;
            
            categories.forEach(category => {
                // "All" and "Favorites" are filters, not assignable categories
                if (category === 'All' || category === 'Favorites') return;

                poemEmotionSelect.innerHTML += `
                    <option value="${category}" ${currentValue === category ? 'selected' : ''}>
                        ${category}
                    </option>
                `;
            });
        }


        function renderPoemsGrid() {
            if (!poemsGrid) return;
            let filteredPoems;
            
            if (activeFilter === 'All') {
                // Filter out "Red Verse" poems from the "All" category
                filteredPoems = allPoems.filter(p => p.emotion !== "Red Verse");
            } else if (activeFilter === 'Favorites') {
                filteredPoems = allPoems.filter(p => favoritePoemIds.includes(p.docId));
            } else if (activeFilter === 'Red Verse') {
                filteredPoems = allPoems.filter(p => p.emotion === "Red Verse");
            } else {
                filteredPoems = allPoems.filter(p => p.emotion === activeFilter);
            }
            
            if (filteredPoems.length === 0) {
                if (!hasLoadedInitialData) {
                    poemsGrid.innerHTML = `<p class="col-span-full text-center opacity-70">Loading poems...</p>`;
                    return;
                }
                if (activeFilter === 'Favorites') {
                    poemsGrid.innerHTML = `<p class="col-span-full text-center opacity-70">You haven't favorited any poems yet.</p>`;
                } else if (activeFilter === 'Red Verse') {
                    poemsGrid.innerHTML = `<p class="col-span-full text-center opacity-70 italic">The verse is unwritten. The page awaits the crimson ink.</p>`;
                } else {
                     poemsGrid.innerHTML = `<p class="col-span-full text-center opacity-70">No poems found in this category.</p>`;
                }
                return;
            }

            poemsGrid.innerHTML = filteredPoems.map(poem => {
                const title = poem.title || "The Space Between";
                const firstLine = poem.content ? `"${poem.content.split('\n')[0]}"` : "";
                const secondLine = poem.content && poem.content.split('\n')[1] ? `"${poem.content.split('\n')[1]}"` : "";
                
                return `
                <div class="poem-card p-6 rounded-lg" style="background-color: var(--c-bg); border: 1px solid var(--c-accent-2);">
                    <div class="flex justify-between items-start">
                        <div class="cursor-pointer flex-grow" data-poem-id="${poem.docId}">
                            <h3 class="font-headline text-xl font-bold" style="color: var(--c-accent-1);">${title}</h3>
                            <p class="mt-2 opacity-70 italic">${firstLine}</p>
                            <p class="opacity-70 italic">${secondLine}</p>
                        </div>
                        <button class="favorite-btn p-2 -mr-2 -mt-2 opacity-50 hover:opacity-100 transition-opacity" data-poem-id="${poem.docId}">
                            ${favoritePoemIds.includes(poem.docId) ? HeartIconFilled : HeartIconOutline}
                        </button>
                    </div>
                </div>
                `
            }).join('');

            poemsGrid.querySelectorAll('.poem-card > div > div').forEach(card => {
                card.addEventListener('click', () => showPoemModal(card.dataset.poemId));
            });
            poemsGrid.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavorite(btn.dataset.poemId)
                });
            });
        }

        function showPoemModal(poemDocId) {
            const poem = allPoems.find(p => p.docId == poemDocId);
            if (poem) {
                currentOpenPoemId = poem.docId; // Set current poem ID
                const title = poem.title || "The Space Between";

                modalContent.innerHTML = `
                    <div class="flex justify-between items-start gap-4">
                        <div>
                            <h2 class="font-headline text-3xl font-bold mb-2" style="color: var(--c-highlight);">${title}</h2>
                            ${poem.subtitle ? `<p class="italic opacity-60 mb-8">${poem.subtitle}</p>` : '<div class="mb-8"></div>'}
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-4">
                            <!-- Share Button -->
                            <button id="shareButton" class="flex items-center gap-1 py-1 px-2 rounded-full text-sm transition-all duration-300 opacity-70 hover:opacity-100" style="color: var(--c-highlight);">
                                ${ShareIcon} Share
                            </button>
                            <!-- Like Button and Count -->
                            <div class="flex items-center gap-1 opacity-80">
                                <button id="likeButton" class="py-1 px-2 rounded-full text-sm transition-all duration-300 disabled:opacity-60" style="color: var(--c-highlight);">
                                    ❤️ Like
                                </button>
                                <span id="likeCount" class="text-sm font-bold" style="color: var(--c-highlight);">0</span>
                            </div>
                            <button class="favorite-btn p-2 opacity-50 hover:opacity-100 transition-opacity" data-poem-id="${poem.docId}">
                                ${favoritePoemIds.includes(poem.docId) ? HeartIconFilled : HeartIconOutline}
                            </button>
                        </div>
                    </div>
                    <div class="whitespace-pre-wrap leading-relaxed">${poem.content.replace(/\n/g, '<br>')}</div>
                    
                    <!-- Reflections Section -->
                    <div class="mt-12 pt-8 border-t" style="border-color: var(--c-accent-2)">
                        <h3 class="font-headline text-xl font-bold mb-4" style="color: var(--c-accent-1);">Reflections</h3>
                        
                        <!-- Comment Form -->
                        <div id="comment-form-container" class="mb-6">
                            <p id="comment-signin-prompt" class="hidden opacity-70">
                                <button class="font-bold underline" style="color: var(--c-accent-1);" id="comment-login-btn">Sign in</button> to leave a reflection.
                            </p>
                            <div id="comment-form" class="hidden">
                                <textarea id="comment" placeholder="Your thoughts..." class="w-full p-3 h-24 rounded-lg border-2 focus:ring-2 outline-none transition-shadow" style="background-color: var(--c-bg); border-color: var(--c-accent-2); color: var(--c-text); --tw-ring-color: var(--c-accent-1);"></textarea>
                                <button id="post-comment-btn" class="mt-2 font-bold py-2 px-5 rounded-full shadow-lg hover:opacity-90 transition-all text-sm" style="background-color: var(--c-accent-1); color: var(--c-bg);">Post</button>
                                <span id="comment-success-msg" class="text-sm ml-3" style="color: var(--c-accent-1); display: none;">Reflection posted!</span>
                            </div>
                        </div>
                        
                        <!-- Comment List -->
                        <div id="list" class="space-y-4 max-h-60 overflow-y-auto">
                            <!-- Comments will be loaded here -->
                        </div>
                    </div>
                `;
                modal.classList.add('visible');
                
                // Add event listeners for modal elements
                modal.querySelector('.favorite-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavorite(e.currentTarget.dataset.poemId);
                });
                modal.querySelector('#shareButton').addEventListener('click', sharePoem);
                modal.querySelector('#likeButton').addEventListener('click', likePost);
                modal.querySelector('#post-comment-btn').addEventListener('click', () => postComment()); // Updated
                modal.querySelector('#comment-login-btn').addEventListener('click', googleLogin);

                
                // Check auth state for comment form
                checkAuthForComments(auth.currentUser);
                // Load comments for this poem
                loadComments(poem.docId);
                // Load likes for this poem
                loadLikes(poem.docId);
            }
        }

        function renderThemeToggle() {
            if (themeToggleButton) {
                themeToggleButton.innerHTML = currentTheme === 'light' ? MoonIcon : SunIcon;
            }
        }

        // --- CORE LOGIC ---
        function toggleTheme() {
            body.classList.add('theme-transition'); 
            clearRedVerseTheme(); // Clear red theme if active
            
            setTimeout(() => {
                docElement.classList.toggle('dark');
                docElement.classList.toggle('light');
                currentTheme = docElement.classList.contains('dark') ? 'dark' : 'light';
                
                renderCategoryFilters();
                renderPoemsGrid();
                renderThemeToggle();
                
                body.classList.remove('theme-transition');
            }, 500);
        }
        
        function setRedVerseTheme() {
            docElement.classList.add('red-verse-theme');
            if (heroSection) {
                heroSection.style.backgroundImage = 'none'; // Remove hero image
            }
        }
        
        function clearRedVerseTheme() {
            if (docElement.classList.contains('red-verse-theme')) {
                docElement.classList.remove('red-verse-theme');
                if (heroSection) {
                    heroSection.style.backgroundImage = `url('https://images.unsplash.com/photo-1455390582262-044cdead277a?q=80&w=1973&auto=format=fit=crop')`; // Restore hero image
                }
            }
        }

        async function toggleFavorite(poemDocId) {
            if (!currentUserId) {
                console.log("Must be logged in to favorite.");
                // Maybe show a sign-in prompt
                googleLogin(); // Let's try to log them in
                return;
            }
            
            const userRef = doc(db, "artifacts", appId, "users", currentUserId);
            
            if (favoritePoemIds.includes(poemDocId)) {
                // Remove from favorites
                try {
                    await updateDoc(userRef, {
                        favoritePoemIds: arrayRemove(poemDocId)
                    });
                    console.log("Removed from favorites");
                } catch (e) {
                    console.error("Error removing favorite: ", e);
                }
            } else {
                // Add to favorites
                try {
                    await updateDoc(userRef, {
                        favoritePoemIds: arrayUnion(poemDocId)
                    });
                    console.log("Added to favorites");
                } catch (e) {
                    console.error("Error adding favorite: ", e);
                }
            }
            
            // Note: The onSnapshot listener for favorites will automatically
            // update the UI, so no need to call renderPoemsGrid() manually.
            // If modal is open, we need to refresh its heart icon.
             if (modal.classList.contains('visible') && currentOpenPoemId === poemDocId) {
                 const modalHeartBtn = modal.querySelector('.favorite-btn');
                 if (modalHeartBtn) {
                    // We manually update here for instant UI feedback
                    // The onSnapshot will correct it if something fails
                    if(favoritePoemIds.includes(poemDocId)) {
                         modalHeartBtn.innerHTML = HeartIconOutline;
                    } else {
                         modalHeartBtn.innerHTML = HeartIconFilled;
                    }
                 }
             }
        }
        
        async function loadUserFavorites(userId) {
            // Unsubscribe from previous user's favorites if exists
            if (userFavoritesUnsubscribe) {
                userFavoritesUnsubscribe();
            }

            const userRef = doc(usersColRef, userId);
            
            // Listen for real-time changes to favorites
            userFavoritesUnsubscribe = onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().favoritePoemIds) {
                    favoritePoemIds = docSnap.data().favoritePoemIds;
                } else {
                    favoritePoemIds = [];
                }
                
                // Re-render the grid and modal (if open) to show new fav status
                renderPoemsGrid();
                if (modal.classList.contains('visible') && currentOpenPoemId) {
                    const modalHeartBtn = modal.querySelector('.favorite-btn');
                    if (modalHeartBtn) {
                        modalHeartBtn.innerHTML = favoritePoemIds.includes(currentOpenPoemId) ? HeartIconFilled : HeartIconOutline;
                    }
                }
            }, (error) => {
                console.error("Error listening to user favorites:", error);
            });
        }

        // --- AUTH FUNCTIONS ---
        const provider = new GoogleAuthProvider();

        window.googleLogin = function(){
            // The 'auth/unauthorized-domain' error is a FIREBASE SETTINGS issue.
            // You must add the domain from the error log (e.g., scf.usercontent.goog)
            // to the Firebase -> Authentication -> Settings -> Authorized domains list.
            signInWithPopup(auth, provider)
            .then(result => {
                console.log("Logged in as " + result.user.displayName);
                // Save user data to Firestore (private)
                // saveUser(result.user); // This is now handled by onAuthStateChanged
            })
            .catch(err => console.error("Google Sign-In Error:", err.code, err.message));
        }

        window.googleLogout = function(){
            signOut(auth).then(() => {
                console.log("Logged out");
            }).catch(err => console.error("Sign Out Error:", err));
        }
        
        // --- ADMIN: Detach all listeners ---
        function cleanupAdminListeners() {
            adminListeners.forEach(unsubscribe => unsubscribe());
            adminListeners = [];
        }

        // --- Auth listener ---
        // This will handle auth using the provided token or anonymous sign-in
        async function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in
                    currentUserId = user.uid;
                    
                    // --- Load initial data ONCE after auth is ready ---
                    if (!hasLoadedInitialData) {
                        console.log("Auth ready, loading initial data...");
                        loadCategories(); // This will load categories, then render filters
                        loadPoemsFromFirestore();
                        hasLoadedInitialData = true;
                    }
                    // --- End initial data load ---
                    
                    if (user.isAnonymous) {
                        console.log("User signed in anonymously:", user.uid);
                        if (userName) userName.textContent = 'Hi, Guest';
                        if (navAuth) navAuth.classList.add('signed-in');
                    } else {
                        console.log("User signed in:", user.displayName);
                        currentUserId = user.uid;
                        // FIX: Check if user.displayName is not null before splitting
                        const displayName = user.displayName ? user.displayName.split(' ')[0] : 'User';
                        if (userName) userName.textContent = `Hi, ${displayName}`;
                        if (navAuth) navAuth.classList.add('signed-in');
                        
                        // Load or create this user's private data doc
                        saveUser(user);
                        // Start listening for this user's favorites
                        loadUserFavorites(user.uid);
                    }
                    
                    // *** ADMIN CHECK ***
                    // Use a more robust check if possible, email might be null
                    if (user.email === 'timelesswhispersmax@gmail.com') {
                        if (adminLink) adminLink.classList.remove('hidden');
                        if (adminSection) adminSection.classList.remove('hidden');
                        // Load all admin data
                        loadAdminData();
                    } else {
                        if (adminLink) adminLink.classList.add('hidden');
                        if (adminSection) adminSection.classList.add('hidden');
                        cleanupAdminListeners(); // Detach listeners if not admin
                    }
                    
                } else {
                    // User is signed out
                    console.log("User signed out.");
                    currentUserId = null;
                    if (userName) userName.textContent = '';
                    if (navAuth) navAuth.classList.remove('signed-in');
                    hasLoadedInitialData = false; // Reset flag
                    
                    // Clear local favorites and re-render
                    favoritePoemIds = [];
                    if (userFavoritesUnsubscribe) {
                        userFavoritesUnsubscribe();
                        userFavoritesUnsubscribe = null;
                    }
                    renderPoemsGrid();
                    
                    // Hide admin panel if signed out
                    if (adminLink) adminLink.classList.add('hidden');
                    if (adminSection) adminSection.classList.add('hidden');
                    cleanupAdminListeners(); // Detach listeners on sign out
                }
                // Update comment form visibility if modal is open
                checkAuthForComments(user);
                // Re-load likes/saves to check user's status
                if(currentOpenPoemId) {
                    loadLikes(currentOpenPoemId);
                }
            });

            // Now, sign in based on the environment
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Signing in with custom token...");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("Signing in anonymously...");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error during initial sign-in:", error);
                // Fallback to anonymous just in case
                if (auth.currentUser == null) {
                    console.log("Retrying with anonymous sign-in...");
                    await signInAnonymously(auth);
                }
            }
        }


        async function saveUser(u){
         // Save user data to a private collection
         // Use the environment-aware appId
         const userRef = doc(db, "artifacts", appId, "users", u.uid);
         try {
            await setDoc(userRef, {
                name: u.displayName,
                email: u.email,
                photo: u.photoURL
            }, {merge:true});
         } catch (e) {
            console.error("Error saving user data: ", e);
         }
        }

        // --- SHARE FUNCTION ---
        window.sharePoem = function() {
            const poem = allPoems.find(p => p.docId == currentOpenPoemId);
            if (!poem) return;
            
            if (navigator.share) {
                navigator.share({
                    title: poem.title,
                    text: `Check out this poem: "${poem.title || 'The Space Between'}"`,
                    url: window.location.href // Shares the main site URL
                })
                .then(() => console.log('Successful share'))
                .catch((error) => console.log('Error sharing', error));
            } else {
                console.log('Web Share API not supported.');
                // Fallback: you could copy a link to the clipboard here
                // Note: navigator.clipboard.writeText may not work in iframe
                // Using document.execCommand as a fallback
                try {
                    const textToCopy = `Check out "${poem.title || 'The Space Between'}" at ${window.location.href}`;
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    console.log('Poem link copied to clipboard (fallback).');
                    // We can't use alert, so maybe show a small message in the modal
                    const shareBtn = document.getElementById('shareButton');
                    if(shareBtn) shareBtn.innerHTML = "Copied!";
                    setTimeout(() => {
                        if(shareBtn) shareBtn.innerHTML = `${ShareIcon} Share`;
                    }, 2000);
                } catch (err) {
                    console.error('Fallback copy failed', err);
                }
            }
        }


        // --- LIKE FUNCTIONS ---

        window.likePost = async function() {
            if (!currentUserId) {
                console.error("Login first to like a post.");
                googleLogin(); // Prompt for login
                return;
            }
            if (auth.currentUser.isAnonymous) {
                console.error("Sign in with Google to like a post.");
                googleLogin(); // Prompt for login
                return;
            }
            if (!currentOpenPoemId) {
                console.error("No poem ID is set.");
                return;
            }

            const likeButton = document.getElementById("likeButton");
            likeButton.disabled = true; // Disable to prevent spam

            // Public likes collection
            // Use environment-aware appId
            const likeRef = doc(db, "artifacts", appId, "public", "data", "likes", `${currentOpenPoemId}_${currentUserId}`);
            const poemRef = doc(poemsColRef, currentOpenPoemId);

            try {
                const likeSnap = await getDoc(likeRef);
                
                if (likeSnap.exists()) {
                    console.log("You have already liked this post.");
                    likeButton.textContent = "❤️ Liked";
                    return; // Already liked
                }

                // User hasn't liked it, so add a new like document
                await setDoc(likeRef, {
                    poemID: currentOpenPoemId,
                    userID: currentUserId,
                    time: serverTimestamp()
                });
                
                // This is a simple (but not perfect) way to increment a counter
                // A Cloud Function would be better for high-traffic
                const poemSnap = await getDoc(poemRef);
                const currentLikes = poemSnap.data().likeCount || 0;
                await updateDoc(poemRef, {
                    likeCount: currentLikes + 1
                });

                // Manually refresh the count
                loadLikes(currentOpenPoemId);
                likeButton.textContent = "❤️ Liked";

            } catch (e) {
                console.error("Error liking post: ", e);
                likeButton.disabled = false; // Re-enable on error
            }
        }

        window.loadLikes = async function(poemDocId) {
            const likeCountSpan = document.getElementById("likeCount");
            const likeButton = document.getElementById("likeButton");
            if (!likeCountSpan || !likeButton) return;

            try {
                // 1. Get the total like count from the poem document itself
                const poemRef = doc(poemsColRef, poemDocId);
                const poemSnap = await getDoc(poemRef);
                if (poemSnap.exists()) {
                    likeCountSpan.textContent = poemSnap.data().likeCount || 0;
                }

                // 2. Check user's like status
                if (currentUserId && auth.currentUser && !auth.currentUser.isAnonymous) {
                    // Use environment-aware appId
                    const likeRef = doc(db, "artifacts", appId, "public", "data", "likes", `${currentOpenPoemId}_${currentUserId}`);
                    const likeSnap = await getDoc(likeRef);
                    
                    if (likeSnap.exists()) {
                        likeButton.disabled = true;
                        likeButton.textContent = "❤️ Liked";
                    } else {
                        likeButton.disabled = false;
                        likeButton.textContent = "❤️ Like";
                    }
                } else {
                    likeButton.disabled = false; // Enable it so they can click to log in
                    likeButton.textContent = "❤️ Sign in to like";
                }

            } catch (e) {
                console.error("Error loading like count: ", e);
            }
        }


        // --- COMMENT FUNCTIONS ---
        
        function checkAuthForComments(user) {
            const commentForm = document.getElementById('comment-form');
            const signinPrompt = document.getElementById('comment-signin-prompt');
            if (!commentForm || !signinPrompt) return; // Modal not open

            if (user && !user.isAnonymous) {
                commentForm.classList.remove('hidden');
                signinPrompt.classList.add('hidden');
            } else {
                commentForm.classList.add('hidden');
                signinPrompt.classList.remove('hidden');
            }
        }

        // Updated to handle replies
        window.postComment = async function(replyToId = null) {
            const user = auth.currentUser;
            if (!user || user.isAnonymous) {
                console.error("Login first!");
                googleLogin(); // Prompt for login
                return;
            }
            if (!currentOpenPoemId) {
                console.error("No poem ID selected.");
                return;
            }

            let text;
            let textEl;
            let postBtn;

            if (replyToId) {
                // We are posting a reply
                textEl = document.getElementById(`reply-text-${replyToId}`);
                postBtn = document.getElementById(`reply-btn-${replyToId}`);
            } else {
                // We are posting a parent comment
                textEl = document.getElementById("comment");
                postBtn = document.getElementById('post-comment-btn');
            }

            if (!textEl) {
                console.error("Could not find text element");
                return;
            }
            text = textEl.value;
            if (!text.trim()) return; // Don't post empty comments

            if (postBtn) {
                postBtn.disabled = true;
                postBtn.textContent = "Posting...";
            }

            try {
                // Save to a public subcollection
                const commentData = {
                    poemID: currentOpenPoemId,
                    userID: user.uid,
                    user: user.displayName, // user's display name
                    text: text,
                    time: serverTimestamp()
                };

                if (replyToId) {
                    commentData.replyTo = replyToId;
                }

                await addDoc(commentsColRef, commentData);
                
                console.log("Comment posted!");
                textEl.value = ""; // Clear textarea

                // If it was a reply, remove the form
                if (replyToId) {
                    const formContainer = document.getElementById(`reply-form-${replyToId}`);
                    if (formContainer) {
                        formContainer.remove();
                    }
                } else {
                    // Show success message for parent comment
                    const successMsg = document.getElementById('comment-success-msg');
                    if (successMsg) {
                        successMsg.style.display = 'inline';
                        setTimeout(() => { successMsg.style.display = 'none'; }, 3000);
                    }
                }
                
                // loadComments() will be triggered by onSnapshot
            } catch (e) {
                console.error("Error posting comment: ", e);
            } finally {
                if (postBtn) {
                    postBtn.disabled = false;
                    postBtn.textContent = "Post";
                }
            }
        };

        // Updated to handle replies
        window.loadComments = async function(poemDocId){
            const list = document.getElementById('list');
            if (!list) return; // Exit if modal isn't open
            list.innerHTML = "<p class='opacity-50'>Loading reflections...</p>";
            
            // If we have a previous listener, detach it
            if (commentsUnsubscribe) {
                commentsUnsubscribe();
            }
            
            const q = query(
                commentsColRef, 
                where("poemID", "==", poemDocId)
                // We will sort in code
            );
            
            commentsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                let allComments = [];
                querySnapshot.forEach(doc => {
                    allComments.push({ ...doc.data(), docId: doc.id });
                });

                // Sort all by time, oldest first
                allComments.sort((a, b) => (a.time?.seconds || 0) - (b.time?.seconds || 0));
                
                // Separate parents and replies
                const parentComments = [];
                const repliesMap = new Map(); // Map<parentId, reply[]>

                for (const comment of allComments) {
                    if (comment.replyTo) {
                        // This is a reply
                        if (!repliesMap.has(comment.replyTo)) {
                            repliesMap.set(comment.replyTo, []);
                        }
                        repliesMap.get(comment.replyTo).push(comment);
                    } else {
                        // This is a parent comment
                        parentComments.push(comment);
                    }
                }
                
                renderComments(parentComments, repliesMap);
                
            }, (error) => {
                console.error("Error listening to comments: ", error);
                list.innerHTML = `<p style='color: var(--c-highlight);'>Error loading reflections. ${error.message}</p>`;
            });
        }

        // Renders one comment (parent or reply)
        function renderSingleComment(comment) {
            const time = comment.time ? new Date(comment.time.seconds * 1000).toLocaleString() : 'Just now';
            // Only parent comments get a reply button
            const replyButton = !comment.replyTo
                ? `<button class="reply-btn text-sm font-bold opacity-70 hover:opacity-100" data-comment-id="${comment.docId}" style="color: var(--c-accent-1);">Reply</button>`
                : '';

            return `
                <div class="comment-container">
                    <div class="border-l-2 pl-3" style="border-color: var(--c-accent-2);">
                        <p class="leading-relaxed">${comment.text}</p>
                        <p class="text-sm opacity-60 mt-1">
                            <strong>${comment.user || 'Anonymous'}</strong> – <span class="text-xs">${time}</span>
                        </p>
                        ${replyButton}
                    </div>
                    <!-- Container for reply form -->
                    <div id="reply-form-${comment.docId}" class="pl-5 mt-2"></div>
                    <!-- Container for replies -->
                    <div id="replies-${comment.docId}" class="pl-5 mt-3 space-y-3 replies-container">
                        <!-- Replies will be injected here -->
                    </div>
                </div>
            `;
        }

        // Updated to render threads
        function renderComments(parentComments, repliesMap) {
            const list = document.getElementById('list');
            if (!list) return;

            if (parentComments.length === 0) {
                list.innerHTML = "<p class='opacity-50'>Be the first to leave a reflection.</p>";
                return;
            }
            
            // Render parent comments
            list.innerHTML = parentComments.map(renderSingleComment).join('');

            // Now, render replies
            for (const [parentId, replies] of repliesMap.entries()) {
                const repliesContainer = document.getElementById(`replies-${parentId}`);
                if (repliesContainer) {
                    repliesContainer.innerHTML = replies.map(renderSingleComment).join('');
                }
            }

            // After HTML is in, attach listeners
            attachCommentButtonListeners();
        }

        function attachCommentButtonListeners() {
            document.querySelectorAll('.reply-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const commentId = e.target.dataset.commentId;
                    showReplyForm(commentId);
                });
            });
        }

        function showReplyForm(commentId) {
            // Remove any other open reply forms
            const existingForms = document.querySelectorAll('.reply-form');
            existingForms.forEach(form => form.remove());

            const formContainer = document.getElementById(`reply-form-${commentId}`);
            if (formContainer) {
                formContainer.innerHTML = `
                    <div class="reply-form">
                        <textarea id="reply-text-${commentId}" placeholder="Write a reply..." class="w-full p-2 h-20 rounded-lg border-2 focus:ring-2 outline-none transition-shadow text-sm" style="background-color: var(--c-bg); border-color: var(--c-accent-2); color: var(--c-text); --tw-ring-color: var(--c-accent-1);"></textarea>
                        <div class="mt-1">
                            <button id="reply-btn-${commentId}" class="font-bold py-1 px-3 rounded-full shadow hover:opacity-90 transition-all text-xs" style="background-color: var(--c-accent-1); color: var(--c-bg);">Post</button>
                            <button class="cancel-reply-btn font-bold py-1 px-3 rounded-full text-xs opacity-70 hover:opacity-100" data-container="reply-form-${commentId}">Cancel</button>
                        </div>
                    </div>
                `;

                // Add listener for the new "Post" button
                document.getElementById(`reply-btn-${commentId}`).addEventListener('click', () => {
                    postComment(commentId);
                });

                // Add listener for the new "Cancel" button
                formContainer.querySelector('.cancel-reply-btn').addEventListener('click', (e) => {
                    const containerId = e.target.dataset.container;
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = '';
                    }
                });
            }
        }
        
        // --- SUBMISSION FORM FUNCTIONS ---
        
        async function handleReviewSubmit(e) {
            e.preventDefault();
            if (!currentUserId) {
                console.error("Login first to submit a review.");
                googleLogin();
                return;
            }
             if (auth.currentUser.isAnonymous) {
                console.error("Sign in with Google to submit a review.");
                googleLogin(); // Prompt for login
                return;
            }
            
            const reviewText = document.getElementById('review-text').value;
            const btn = document.getElementById('post-review-btn');
            const msg = document.getElementById('review-message');
            if (!reviewText.trim()) return;
            
            btn.disabled = true;
            btn.textContent = "Sending...";
            
            try {
                // 1. Save to user's private collection in Firestore
                // Use environment-aware appId
                await addDoc(collection(db, "artifacts", appId, "users", currentUserId, "reviews"), {
                    text: reviewText,
                    createdAt: serverTimestamp()
                });

                // 2. Clear form and show success
                document.getElementById('review-text').value = '';
                msg.textContent = "Feedback sent. Thank you!";
                msg.classList.remove('hidden');
                setTimeout(() => { msg.classList.add('hidden'); }, 4000);

            } catch (error) {
                console.error('Error submitting review:', error);
                msg.textContent = "Error sending feedback.";
                msg.classList.remove('hidden', 'text-green-600');
                setTimeout(() => { msg.classList.add('hidden'); }, 4000);
            } finally {
                btn.disabled = false;
                btn.textContent = "Send Feedback";
            }
        }

        async function handlePoemSubmit(e) {
            e.preventDefault();
            if (!currentUserId) {
                console.error("Login first to submit a poem.");
                googleLogin();
                return;
            }
             if (auth.currentUser.isAnonymous) {
                console.error("Sign in with Google to submit a poem.");
                googleLogin(); // Prompt for login
                return;
            }
            
            const title = document.getElementById('submission-title').value;
            const content = document.getElementById('submission-content').value;
            const btn = document.getElementById('post-submission-btn');
            const msg = document.getElementById('submission-message');
            if (!title.trim() || !content.trim()) return;

            btn.disabled = true;
            btn.textContent = "Submitting...";

            try {
                // 1. Save to user's private collection in Firestore
                // Use environment-aware appId
                await addDoc(collection(db, "artifacts", appId, "users", currentUserId, "submissions"), {
                    title: title,
                    content: content,
                    createdAt: serverTimestamp()
                });

                // 2. Clear form and show success
                document.getElementById('submission-title').value = '';
                document.getElementById('submission-content').value = '';
                msg.textContent = "Poem submitted. Thank you!";
                msg.classList.remove('hidden');
                setTimeout(() => { msg.classList.add('hidden'); }, 4000);

            } catch (error) {
                console.error('Error submitting poem:', error);
                msg.textContent = "Error submitting poem.";
                msg.classList.remove('hidden', 'text-green-600');
                setTimeout(() => { msg.classList.add('hidden'); }, 4000);
            } finally {
                btn.disabled = false;
                btn.textContent = "Submit Poem";
            }
        }

        // --- ADMIN PANEL FUNCTIONS ---
        
        // --- 1. Load All Data ---
        function loadAdminData() {
            // Detach old listeners before attaching new ones
            cleanupAdminListeners();
            
            // Attach new listeners and store them
            adminListeners.push(loadPoemsForAdmin());
            adminListeners.push(loadCommentsForAdmin());
            adminListeners.push(loadSubmissionsForAdmin());
        }
        
        // --- 2. Load Poems (for Admin List) ---
        function loadPoemsForAdmin() {
            // We sort by the 'id' field, which is the original numeric ID
            const q = query(poemsColRef);
            const unsubscribe = onSnapshot(q, (snapshot) => {
                if (!adminPoemList) return;
                adminPoemList.innerHTML = ''; // Clear list
                statTotalPoems.textContent = snapshot.size; // Update stat
                
                if (snapshot.empty) {
                    adminPoemList.innerHTML = `<p class="opacity-70">No poems found.</p>`;
                    return;
                }
                
                let adminPoems = [];
                snapshot.forEach(doc => {
                    adminPoems.push({ ...doc.data(), docId: doc.id });
                });

                // Sort in code by the 'id' field
                adminPoems.sort((a, b) => (b.id || 0) - (a.id || 0));

                adminPoems.forEach(poem => {
                    const title = poem.title || "The Space Between";
                    const poemEl = document.createElement('div');
                    poemEl.className = "flex justify-between items-center p-3 rounded-lg";
                    poemEl.innerHTML = `
                        <div>
                            <p class="font-bold">${title}</p>
                            <p class="text-sm opacity-70">Category: ${poem.emotion}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-poem-btn text-sm font-medium text-blue-500 hover:underline" data-id="${poem.docId}">Edit</button>
                            <button class="delete-poem-btn text-sm font-medium text-red-500 hover:underline" data-id="${poem.docId}">Delete</button>
                        </div>
                    `;
                    adminPoemList.appendChild(poemEl);
                });
                
                // Attach event listeners for new buttons
                adminPoemList.querySelectorAll('.edit-poem-btn').forEach(btn => {
                    btn.addEventListener('click', () => editPoem(btn.dataset.id));
                });
                adminPoemList.querySelectorAll('.delete-poem-btn').forEach(btn => {
                    btn.addEventListener('click', () => deletePoem(btn.dataset.id));
                });
                
            }, (error) => {
                console.error("Error loading admin poems:", error);
                adminPoemList.innerHTML = `<p class="text-red-500">Error loading poems.</p>`;
            });
            return unsubscribe; // Return for cleanup
        }
        
        // --- 3. Load Comments (for Moderation) ---
        function loadCommentsForAdmin() {
            const q = query(commentsColRef, orderBy("time", "desc"));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                if (!adminCommentList) return;
                adminCommentList.innerHTML = ''; // Clear list
                statTotalComments.textContent = snapshot.size; // Update stat

                if (snapshot.empty) {
                    adminCommentList.innerHTML = `<p class="opacity-70">No comments found.</p>`;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    const time = comment.time ? new Date(comment.time.seconds * 1000).toLocaleString() : 'Just now';
                    const commentEl = document.createElement('div');
                    commentEl.className = "p-3 border-l-2"
                    commentEl.innerHTML = `
                        <p class="mb-1">"${comment.text}"</p>
                        <p class="text-sm opacity-70">By: <strong>${comment.user}</strong> on ${time}</p>
                        <button class="delete-comment-btn text-sm font-medium text-red-500 hover:underline" data-id="${doc.id}">Delete</button>
                    `;
                    adminCommentList.appendChild(commentEl);
                });
                
                // Attach listeners
                adminCommentList.querySelectorAll('.delete-comment-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteComment(btn.dataset.id));
                });
                
            }, (error) => {
                console.error("Error loading admin comments:", error);
                adminCommentList.innerHTML = `<p class="text-red-500">Error loading comments.</p>`;
            });
            return unsubscribe; // Return for cleanup
        }
        
        // --- 4. Load Submissions (from all users) ---
        function loadSubmissionsForAdmin() {
            // This listener will update the user count stat
            const unsubscribe = onSnapshot(usersColRef, async (usersSnapshot) => {
                if (!adminReviewList || !adminSubmissionList) return;
                
                adminReviewList.innerHTML = '';
                adminSubmissionList.innerHTML = '';
                statTotalUsers.textContent = usersSnapshot.size; // Update stat
                
                let reviewsFound = false;
                let submissionsFound = false;

                for (const userDoc of usersSnapshot.docs) {
                    const user = userDoc.data();
                    
                    // Get Reviews
                    // Use environment-aware appId
                    const reviewsRef = collection(db, "artifacts", appId, "users", userDoc.id, "reviews");
                    const reviewsSnap = await getDocs(query(reviewsRef, orderBy("createdAt", "desc")));
                    reviewsSnap.forEach(doc => {
                        reviewsFound = true;
                        const review = doc.data();
                        const time = review.createdAt ? new Date(review.createdAt.seconds * 1000).toLocaleString() : 'Just now';
                        const el = document.createElement('div');
                        el.className = "p-3 border-l-2";
                        el.innerHTML = `
                            <p class="mb-1">"${review.text}"</p>
                            <p class="text-sm opacity-70">By: <strong>${user.name}</strong> on ${time}</p>
                        `;
                        adminReviewList.appendChild(el);
                    });
                    
                    // Get Submissions
                    // Use environment-aware appId
                    const submissionsRef = collection(db, "artifacts", appId, "users", userDoc.id, "submissions");
                    const submissionsSnap = await getDocs(query(submissionsRef, orderBy("createdAt", "desc")));
                    submissionsSnap.forEach(doc => {
                        submissionsFound = true;
                        const submission = doc.data();
                        const time = submission.createdAt ? new Date(submission.createdAt.seconds * 1000).toLocaleString() : 'Just now';
                        const el = document.createElement('div');
                        el.className = "p-3 border-l-2";
                        el.innerHTML = `
                            <p class="font-bold">${submission.title}</p>
                            <p class="mb-1 whitespace-pre-wrap">${submission.content}</p>
                            <p class="text-sm opacity-70">By: <strong>${user.name}</strong> on ${time}</p>
                        `;
                        adminSubmissionList.appendChild(el);
                    });
                }
                
                if (!reviewsFound) adminReviewList.innerHTML = `<p class="opacity-70">No reviews found.</p>`;
                if (!submissionsFound) adminSubmissionList.innerHTML = `<p class="opacity-70">No poem submissions found.</p>`;

            }, (error) => {
                console.error("Error loading user submissions:", error);
            });
            return unsubscribe; // Return for cleanup
        }
        
        // --- 5. Admin Action: Delete Poem ---
        async function deletePoem(poemDocId) {
            if (!poemDocId) return;
            // Note: We might want to delete all comments/likes associated with this poem too.
            // For now, just delete the poem.
            try {
                await deleteDoc(doc(poemsColRef, poemDocId));
                console.log("Poem deleted:", poemDocId);
                // The onSnapshot listener will auto-update the list
            } catch (error) {
                console.error("Error deleting poem:", error);
            }
        }
        
        // --- 6. Admin Action: Delete Comment ---
        async function deleteComment(commentDocId) {
            if (!commentDocId) return;
            try {
                await deleteDoc(doc(commentsColRef, commentDocId));
                console.log("Comment deleted:", commentDocId);
                // The onSnapshot listener will auto-update the list
            } catch (error) {
                console.error("Error deleting comment:", error);
            }
        }
        
        // --- 7. Admin Action: Edit Poem (Load data into form) ---
        function editPoem(poemDocId) {
            const poem = allPoems.find(p => p.docId === poemDocId);
            if (!poem) return;
            
            // Store the ID for the submit handler
            poemFormEditId = poemDocId;
            
            // Populate the form
            document.getElementById('poem-title').value = poem.title || '';
            document.getElementById('poem-content').value = poem.content || '';
            document.getElementById('poem-emotion').value = poem.emotion || '';
            
            // Change UI
            poemFormTitle.textContent = "Edit Poem";
            submitBtn.textContent = "Update Poem";
            
            // Switch to the "Add/Edit Poem" tab
            adminTabs.forEach(t => t.classList.remove('admin-tab-active'));
            addEditPoemTab.classList.add('admin-tab-active');
            adminTabContents.forEach(c => c.classList.add('hidden'));
            document.getElementById('content-add-edit-poem').classList.remove('hidden');
        }
        
        // --- 8. Admin Action: Reset Poem Form ---
        function resetPoemForm() {
            poemForm.reset();
            poemFormEditId = null;
            poemFormTitle.textContent = "Add a New Poem";
            submitBtn.textContent = "Submit Poem";
            statusMessage.classList.add('hidden');
        }

        // --- 9. Admin Panel Form Logic (Handles BOTH Add and Edit) ---
        function showStatus(message, isError = false) {
            if (statusMessage) { // Add check in case admin HTML is missing
                statusMessage.textContent = message;
                statusMessage.className = `text-sm ${isError ? 'text-red-600' : 'text-green-600'}`;
                statusMessage.classList.remove('hidden');
            }
        }
        
        if (poemForm) { // Only attach listener if the form exists
            poemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const title = document.getElementById('poem-title').value;
                const content = document.getElementById('poem-content').value;
                const emotion = document.getElementById('poem-emotion').value;

                if (!title || !content || !emotion) {
                    showStatus("Please fill out all fields.", true);
                    return;
                }

                submitBtn.disabled = true;
                loadingIndicator.classList.remove('hidden');
                
                try {
                    if (poemFormEditId) {
                        // --- UPDATE existing poem ---
                        showStatus("Updating...", false);
                        const poemRef = doc(poemsColRef, poemFormEditId);
                        await updateDoc(poemRef, {
                            title: title,
                            content: content,
                            emotion: emotion
                            // We don't update the 'id' field
                        });
                        console.log("Poem updated with ID: ", poemFormEditId);
                        showStatus("Poem updated successfully!", false);
                        resetPoemForm();
                        
                    } else {
                        // --- ADD new poem ---
                        showStatus("Submitting...", false);
                        // 1. Get all existing poems to find the highest ID
                        const q = query(poemsColRef); // No need to order, just get all
                        const snapshot = await getDocs(q);
                        let highestId = 0;
                        if (!snapshot.empty) {
                            snapshot.docs.forEach(doc => {
                                const docId = doc.data().id || 0;
                                if (docId > highestId) {
                                    highestId = docId;
                                }
                            });
                        }
                        
                        // 2. Create the new poem object with the next ID
                        const newPoem = {
                            title: title,
                            content: content,
                            emotion: emotion,
                            id: highestId + 1 // Ensure new poems sort to the end
                        };

                        // 3. Add the new poem to the correct collection
                        const docRef = await addDoc(poemsColRef, newPoem);
                        
                        console.log("Poem submitted with ID: ", docRef.id);
                        showStatus("Poem submitted successfully!", false);
                        poemForm.reset();
                    }

                } catch (error) {
                    console.error("Error adding/updating poem: ", error);
                    showStatus(`Error: ${error.message}`, true);
                } finally {
                    submitBtn.disabled = false;
                    loadingIndicator.classList.add('hidden');
                }
            });
        }
        
        // --- 10. Admin Tab Switching Logic ---
        if (adminTabs) {
            adminTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.dataset.tab;
                    
                    // Update tab styles
                    adminTabs.forEach(t => t.classList.remove('admin-tab-active'));
                    tab.classList.add('admin-tab-active');
                    
                    // Show/hide content
                    adminTabContents.forEach(content => {
                        if (content.id === `content-${target}`) {
                            content.classList.remove('hidden');
                        } else {
                            content.classList.add('hidden');
                        }
                    });
                    
                    // If switching to Add/Edit tab, reset the form
                    if (target === 'add-edit-poem') {
                        resetPoemForm();
                    }
                });
            });
        }
        
        // --- 11. Admin Add Category Logic ---
        if (addCategoryBtn) {
            addCategoryBtn.addEventListener('click', async () => {
                const newCategoryName = newCategoryInput.value.trim();
                if (!newCategoryName) {
                    showStatus("Please enter a category name.", true);
                    return;
                }
                // Check if category already exists (case-insensitive)
                if (categories.some(cat => cat.toLowerCase() === newCategoryName.toLowerCase())) {
                    showStatus("This category already exists.", true);
                    return;
                }

                try {
                    addCategoryBtn.disabled = true;
                    showStatus("Adding category...", false);
                    // Update the document in Firestore
                    await updateDoc(categoriesDocRef, {
                        list: arrayUnion(newCategoryName)
                    });
                    // The onSnapshot listener will automatically update the UI
                    newCategoryInput.value = '';
                    showStatus("Category added!", false);
                } catch (error) {
                    console.error("Error adding category:", error);
                    showStatus("Error adding category.", true);
                } finally {
                    addCategoryBtn.disabled = false;
                }
            });
        }

        
        // --- EVENT LISTENERS ---
        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', () => {
                modal.classList.remove('visible');
                renderPoemsGrid();
                currentOpenPoemId = null;
                if (commentsUnsubscribe) {
                    commentsUnsubscribe(); // Detach listener when modal closes
                    commentsUnsubscribe = null;
                }
            });
        }
        
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('visible');
                    renderPoemsGrid();
                    currentOpenPoemId = null;
                    if (commentsUnsubscribe) {
                        commentsUnsubscribe(); // Detach listener when modal closes
                        commentsUnsubscribe = null;
                    }
                }
            });
        }

        // --- Red Verse Modal Listeners ---
        if (redVerseCloseBtn) {
            redVerseCloseBtn.addEventListener('click', () => {
                redVerseModal.classList.remove('visible');
            });
        }
        if (redVerseCancelBtn) {
            redVerseCancelBtn.addEventListener('click', () => {
                redVerseModal.classList.remove('visible');
            });
        }
        if (redVerseModal) {
            redVerseModal.addEventListener('click', (e) => {
                if (e.target === redVerseModal) {
                    redVerseModal.classList.remove('visible');
                }
            });
        }
        if (redVerseSubmitBtn) {
            redVerseSubmitBtn.addEventListener('click', () => {
                const password = redVersePasswordInput.value;
                if (password === 'redkey') {
                    // Correct password
                    redVerseModal.classList.remove('visible');
                    setRedVerseTheme();
                    activeFilter = 'Red Verse';
                    renderCategoryFilters();
                    renderPoemsGrid();
                } else {
                    // Incorrect password
                    redVerseError.classList.remove('hidden');
                }
            });
        }
        
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetElement = document.querySelector(this.getAttribute('href'));
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth'
                    });
                }
            }); 
        });

        // FIX: Moved all data-dependent initialization into setupAuthListener
        // Only non-data, non-auth listeners should be here.
        async function init() {
            // Attach login/logout to buttons in nav
            if (loginBtn) loginBtn.addEventListener('click', googleLogin);
            if (logoutBtn) logoutBtn.addEventListener('click', googleLogout);
            
            // Attach other non-data-dependent listeners
            if (themeToggleButton) {
                renderThemeToggle();
                themeToggleButton.addEventListener('click', toggleTheme);
            }
            if (document.getElementById('review-form')) {
                document.getElementById('review-form').addEventListener('submit', handleReviewSubmit);
            }
            if (document.getElementById('submission-form')) {
                document.getElementById('submission-form').addEventListener('submit', handlePoemSubmit);
            }

            // Set up the authentication listener
            // This will also handle the initial sign-in and trigger data loading
            await setupAuthListener();

            // Note: Data loading (loadCategories, loadPoemsFromFirestore)
            // is now called INSIDE setupAuthListener once auth is ready.
        }
        
        // --- INITIALIZATION ---
        
        // This is the array of poems that will be auto-uploaded
        // ONCE, if the database is empty.
        const defaultPoems = [
            { id: 1, title: 'The Eyes of Her Soul', emotion: 'Love', content: `The secrets of her soul are reflected in her eyes,\nWhich are like two pools of liquid light.\nDeep within them lies an untold universe,\nA beautifully scrolled story of emotions.\n\nJust a quick look can captivate me\nAnd transport me to the depths of her stunning eyes.\nA glimpse of the calm and perceptive soul,\nA kaleidoscope of emotions and invisible colors.` },
            { id: 2, title: 'In Her Presence', emotion: 'Love', content: `The sun is not as bright when I am not with her.\nIn her absence, the clouds are ominous and threatening.\nThe birds’ singing becomes less melodious\nWhen I am not around her.\n\nI feel like the walls close in on me\nWhen I’m not with her.\nWhispering her name keeps me going\nWhen I am desolate and without her.\n\nBut she gives me a boost when we are together.\nIn her presence, I possess the strength to move mountains.\nI am capable of withstand- ing anything\nWhen I am with her.\n\nWhen we are together,\nHer smile makes me feel so happy.\nThe angels sing her name\nWhen we are together.\n\nI fall in love all over again\nWhen we are together.` },
            { id: 3, title: 'The Lips of Desire', emotion: 'Chaos', content: `The lips are sweet.\nI am not sure how to touch them.\nThat enslaves me with their grandeur.\nI wondered if I should see them near.\nUpper and lower are so tender.\nWhen together makes me happy.\nThey yearn to be perceived when drenched.\nThey want to be embraced.\nThe lips laugh.\nYour prongs make me look.\nThe lips that moan and the lips that sigh.\nIt takes me to a high.\nI want to have a child within my imprisoned wish.\nlaugh at the way they deceive.\nWords whisper, I want to hear them.\nI have to keep the memories in tact.\nThe lips of love and the lips of ire.\nThe lips were sweet and on fire.\nThere are lips of golden heavenly mire.\nI hope they don’t leave me in a bad situation.` },
            { id: 4, title: 'When We First Met', emotion: 'Love', content: `The moment we first met,\nI knew we were meant to be.\nWe were destined to be together,\nAnd I knew you were the one.\n\nI had no idea who you were.\nAll I knew was your name.\nI had no idea what to do.\nI couldn’t decide who was at fault.\n\nI was aware of my attraction to you.\nYou seemed like a good person to me.\nThe butterflies were moving so quickly\nThat I had to stop and consider.\n\nNothing I did that day\nRevealed who I am to you.\nMy heart started to race\nEvery time you approached me.\n\nMy behavior wasn’t typical.\nMy responses weren’t sincere.\nI couldn’t control my heart,\nEven though I felt so awful.\n\nAnd you were the center of my attention\nWhen the group bid me farewell.\nI knew I was attempting to find out\nIf you shared my sentiments.\n\nWhen I saw your face,\nI liked you; however,\nIt might inave been the touch.\nMy heart was racing already.\n\nI was already too fond of you.\nThe moment we first met,\nI knew we were meant to be.\nI was aware that we were destined to be\nEnemies, lovers, and friends.` },
            { id: 5, title: 'A Love Divinely Crafted', emotion: 'Hope', content: `Though I’ve always known that love would find me eventually,\nI had no idea that it would be you.\nIn the same way that you captivate me when I gaze into your eyes,\nYou caught me off guard and took me by surprise.\n\nIt is a fact that all excellent and flawless gifts\nCome from above.\nI was given you as a gorgeously wrapped gift,\nFull of intelligence, humor, talent, beauty, and love.\n\n“Learning to see an imperfect person perfectly\nIs more important than searching for the ideal person.”\nWe all have imperfections,\nBut from my perspective, you are flawless.\n\nI still enjoy the small things you do,\nLike hearing you laugh and noticing how your nose wrinkles,\nEven when you’re upset, as well.\nI’m confident that we can accomplish anything\nAs long as we’re traveling this path together.\n\nI occasionally question whether what we have is too good to be true.\nI’m afraid of losing you and of having my heart broken,\nBut ultimately, I put my trust in the one who created and perfected what I believe,\nBecause He will grant us our requests.\n\nAs they say, “Where your treasure is, your heart will be also.”\nGod alone knows what tomorrow will bring, so I may not know.\nAll I know is that you are my one and only.\n\nGod made everything beautiful, precious, and new,\nJust as beautiful and precious as the day will be,\nWhen I look into your eyes and say,\n“I Love You.”` },
            { id: 6, title: 'The Essence of Love', emotion: 'Love', content: `To love is a journey through life, hand in hand,\nTo craft dreams that belong to just us two,\nTo labor together, side by side,\nAnd bask in the joy,\nAs one by one, our aspirations unfold.\n\nTo love is to uplift and inspire,\nWith warm smiles and heartfelt words of encouragement,\nTo carve out moments to connect,\nTo listen and nurture\nIn gentle, loving ways.\n\nTo love is to cherish someone unique,\nA steadfast presence through the passage of time,\nSharing both laughter and sorrow,\nAs a partner, a confidant, a beloved friend.\n\nTo love is to create cherished memories,\nOf moments that bring joy to our hearts,\nOf all the beautiful gifts\nThat life shared together offers. Love is the ultimate treasure.\n\nI’ve discovered the true essence\nOf sharing and caring,\nAnd new witnessing my dreams blossom;\nI’ve embraced the full meaning\nOf being in love\nBy simply being and loving you.` },
            { id: 7, title: 'I Will Always Love You', emotion: 'Hope', content: `Even though you will occasionally annoy me and make me feel angry,\n“I will always love you.”\n\n“I will always love you, even though there are some hurtful things you might say\nThat will make me sad.”\n\nI will always love you,\nEven though I know that you will disappoint me with some foolish choices.\n\n“I will always love you, even though there are things you might do\nThat make me worry about you.”\n\n“I will. always love you, even though there will be times\nWhen you will bring me to tears.”\n\n“You will make mistakes that I cannot forgive,\nBut I will always love you regardless.”\n\nI will always love you,\nDespite the lies you tell me to try to undermine my faith in you.\n\n“I want you to know that, despite the difficulties,\nDisagreements, and trials we will face in life,\n‘I will always love you,’ both now and in the future.”` },
            { id: 8, title: 'In the Shadow of Your Presence', emotion: 'Silent Nights', content: `In a world where I’ve never asked for anything,\nI find myself in awe of how everything feels complete,\nFor you belong to me.\nYour presence alone fills my heart,\nAnd without you, this world loses its meaning.\nIt’s as if the universe conspired to bring us together,\nCrafting moments that shimmer with the essence of what could be.\nEach day unfolds like a page in a story\nThat I never knew I was longing to write,\nAnd you are the ink that brings it to life.\n\nIn my dreams, there exists a sacred space\nWhere it’s just you and me, untouched by anyone else.\nA realm where time stands still,\nAnd the outside world fades into a distant memory.\nOh, how I long for you to arrive!\nThe anticipation of your presence is a melody\nThat plays softly in my heart,\nA song that echoes through the corridors of my mind.\nAre our destinies woven together in this beautiful tapestry?\nEach thread a promise, each color a memory waiting to be made.\nIf our paths were to cross,\nI would fall hopelessly in love with you,\nSurrendering to the gravity of your essence.\nEven if fate keeps us apart, my heart will still yearn for you,\nFor you are mine—a truth that resonates deep within my soul.\n\nYou wonder what I see in you amidst the beauty that surrounds us.\nLittle do you know, you are the most captivating sight of all.\nPlease, look at yourself through my eyes.\nBeneath your hair lies a radiant smile,\nA beacon of warmth that lights up even the darkest corners of my heart.\nYour eyes dance with a light that draws me in,\nSparkling with a thousand unspoken stories,\nEach one more enchanting than the last.\n\nWhat can I say about your lips,\nThe ones that whisper sweet names to me?\nThey hold the. power to ignite a fire within me,\nA warmth that spreads through my veins like a gentle flame.\nAnd your heart—oh, how magnificent it is!\nIt beats with a rhythm that harmonizes with my own,\nA symphony of emotions that transcends the ordinary.\n\nPicture us, two hearts walking hand in hand,\nNavigating the world together,\nEach step a testament to our connection.\nWill the sky be clear, or will it rain?\nEven if the clouds gather, I would choose to be by your side,\nFor you are my everything.\nIn the storm, I would find solace in your embrace,\nAnd in the sunshine, I would bask in the glow of your laughter.\n\Togeth- er, we would create a universe of our own,\nA sanctuary.` },
            { id: 9, title: 'A Soul Shattered by Love', emotion: 'Loss', content: `How can I mend a shattered soul?\nMy entire existence has crumbled.\nHow can I find solace in a new beginning,\nWhen the person I cherish is no longer present?\n\nMy thoughts are consumed by memories of you,\nOf all we’ve experienced, all we shared.\nI long for your touch and your comforting embrace,\nThe look in your eyes, the smile on your lips.\n\nMy dreams are filled with the tender kiss of yours.\nI wake up and weep for what I’ve lost.\nHow can I heal a broken heart,\nWhen my one true love and I are apart?\n\nMy heart is destined to love only you,\nIt refuses to let go, what should I do?\nOur moments together were rare and precious,\nBut I treasured them more than you could ever know.\n\nI love you, my angel, and always will.\nI felt love for you then, and I feel it still.` },
            { id: 10, title: 'Under the Moonlit Spell', emotion: 'Love', content: `Beneath the glimmering moonlight,\nUnder a blanket of stars,\nI find myself intertwined with you\nIn a faraway place that feels like ours.\n\nThe world is silent,\nAnd all I can sense\nIs the soft rhythm of our shared breaths.\nYou have me enchanted, my heart tightly ensnared,\nLost in your essence, where true love is declared.\n\nYour lips graze my neck,\nIgniting a flame,\nEach gentle touch\nStokes my desire’s name.\n\nAs my body awakens,\nIt yearns for your caress,\nLonging for your embrace,\nCraving you more and more, I confess.\n\nWith every movement,\nA smile dances on my face,\nShould I whisper sweet nothings\nOr let passion take its place?\n\nYou tug at your hair,\nLifting me high,\nFloating on clouds,\nAs if we could soar through the sky.\n\nAs I shiver and tremble,\nOur hearts begin to race,\nIn this moonlit sanctuary,\nI’m yours in this space.` },
        ];

        async function seedDatabaseIfNeeded() {
            // Check if poems are already in the database
            const q = query(poemsColRef);
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                console.log("No poems found in DB. Seeding...");
                // Database is empty, let's upload the default poems
                for (const poem of defaultPoems) {
                    try {
                        // Add each poem as a new document
                        // The document ID will be auto-generated by Firebase
                        await addDoc(poemsColRef, poem);
                    } catch (e) {
                        console.error("Error seeding poem: ", e);
                    }
                }
                console.log("Database seeding complete.");
            } else {
                console.log("Poems already exist in database. Skipping seed.");
            }
        }
        
        async function loadPoemsFromFirestore() {
            try {
                // First, check if we need to seed the DB
                await seedDatabaseIfNeeded();
                
                // Now, load all poems from the database
                // We use onSnapshot to listen for real-time updates
                const q = query(poemsColRef); 
                onSnapshot(q, (snapshot) => {
                    allPoems = []; // Clear the local array
                    snapshot.forEach((doc) => {
                        allPoems.push({
                            ...doc.data(),
                            docId: doc.id // Store the unique Firebase Document ID
                        });
                    });

                    // Sort in code to avoid Firebase index issues
                    allPoems.sort((a, b) => (a.id || 0) - (b.id || 0));
                    
                    // --- DEBUGGING CODE ---
                    // Log all loaded poems to see what data is coming from Firestore.
                    console.log("All poems loaded from Firestore:", allPoems); 
                    
                    // Log all "emotion" fields the code can see.
                    const emotionsInDB = allPoems.map(p => p.emotion);
                    console.log("Emotions found in database:", [...new Set(emotionsInDB)]); // Use Set to show unique values
                    // --- END DEBUGGING CODE ---
                    
                    // Once poems are loaded, render the grid
                    renderPoemsGrid();

                }, (error) => {
                    console.error("Error listening to poems from Firestore: ", error);
                    if (poemsGrid) {
                        poemsGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Error: Could not load poems. ${error.message}</p>`;
                    }
                });
                
            } catch (error) {
                console.error("Error loading poems from Firestore: ", error);
                if (poemsGrid) {
                    poemsGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Error: Could not load poems. ${error.message}</p>`;
                }
            }
        }

        init();
    });
    </script>

    <style>
        /* --- Custom Styles & Theming --- */
        :root {
            /* ☀️ Light Mode: “Earthbound Elegance” */
            --light-bg: #FFF9F2;
            --light-text: #3B2F2F;
            --light-accent-1: #A67C52;
            --light-accent-2: #D4BFAA;
            --light-highlight: #6B4226;
            --light-bg-transparent: rgba(255, 249, 242, 0.65);
            --light-border-transparent: rgba(255, 255, 255, 0.2);

            /* 🌙 Dark Mode: “Sepia Eclipse” */
            --dark-bg: #1C1A18;
            --dark-text: #E8DCCF;
            --dark-accent-1: #A67C52;
            --dark-accent-2: #533C2C;
            --dark-highlight: #E2B27E;
            --dark-bg-transparent: rgba(28, 26, 24, 0.65);
            --dark-border-transparent: rgba(255, 255, 255, 0.1);
            
            /* ❤️ Red Verse Mode: “Romantic Crimson” */
            --red-bg: #1F1F1F; /* Dark Charcoal */
            --red-text: #E8DCCF;
            --red-accent-1: #B22222; /* Firebrick Red */
            --red-accent-2: #5A1C1C;
            --red-highlight: #F0A0A0; /* Lighter red for highlights */
            --red-bg-transparent: rgba(31, 31, 31, 0.65);
            --red-border-transparent: rgba(255, 255, 255, 0.1);
            
            --c-bg: var(--light-bg);
            --c-text: var(--light-text);
            --c-accent-1: var(--light-accent-1);
            --c-accent-2: var(--light-accent-2);
            --c-highlight: var(--light-highlight);
            --c-bg-transparent: var(--light-bg-transparent);
            --c-border-transparent: var(--light-border-transparent);
        }

        html.dark {
             --c-bg: var(--dark-bg);
             --c-text: var(--dark-text);
             --c-accent-1: var(--dark-accent-1);
             --c-accent-2: var(--dark-accent-2); 
             --c-highlight: var(--dark-highlight);
             --c-bg-transparent: var(--dark-bg-transparent);
             --c-border-transparent: var(--dark-border-transparent);
        }
        
        html.red-verse-theme {
             --c-bg: var(--red-bg);
             --c-text: var(--red-text);
             --c-accent-1: var(--red-accent-1);
             --c-accent-2: var(--red-accent-2); 
             --c-highlight: var(--red-highlight);
             --c-bg-transparent: var(--red-bg-transparent);
             --c-border-transparent: var(--red-border-transparent);
        }
        
        /* Red Verse Hero Override */
        html.red-verse-theme #about {
            background-image: none !important;
            background-color: var(--c-bg) !important;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--c-bg);
            color: var(--c-text);
            transition: background-color 0.5s, color 0.5s;
        }

        /* --- Font Families --- */
        .font-headline { font-family: 'Playfair Display', serif; }
        .font-body { font-family: 'Raleway', sans-serif; }
        .font-name { font-family: 'Cinzel Decorative', serif; }
        .font-writing { font-family: 'Lora', serif; }

        /* --- Animations --- */
        @keyframes fade-in-up { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .fade-in-up { 
            animation: fade-in-up 0.8s ease-out forwards; 
            opacity: 0;
        }
        .fade-in-up-delay-1 { animation-delay: 0.2s; }
        .fade-in-up-delay-2 { animation-delay: 0.4s; }
        .fade-in-up-delay-3 { animation-delay: 0.6s; }

        /* --- Theme Transition --- */
        body.theme-transition {
            transition: filter 0.5s ease-in-out;
            filter: blur(5px);
        }
        
        /* --- Gallery Card --- */
        .poem-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .poem-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        html.dark .poem-card:hover, html.red-verse-theme .poem-card:hover {
             box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        /* --- Modal --- */
        #quick-preview-modal {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #quick-preview-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #quick-preview-modal .modal-content {
            transition: transform 0.4s ease-out;
            transform: scale(0.95);
        }
        #quick-preview-modal.visible .modal-content {
            transform: scale(1);
        }
        
        .favorite-btn .heart-filled {
            color: var(--c-highlight);
        }

        /* --- Red Verse Modal --- */
        #red-verse-modal {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #red-verse-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #red-verse-modal .modal-content {
            transition: transform 0.4s ease-out;
            transform: scale(0.95);
        }
        #red-verse-modal.visible .modal-content {
            transform: scale(1);
        }
        
        /* --- Floating Nav --- */
        #top-nav {
            /* Liquid Glass morphism */
            background-color: var(--c-bg-transparent);
            backdrop-filter: blur(20px); /* Increased blur */
            border: 1px solid var(--c-border-transparent); /* Softer edge */

            /* New properties for Dynamic Island effect */
            max-width: 270px; /* Adjusted for title + padding */
            overflow: hidden;
            white-space: nowrap;
            /* Springy transition for the container */
            transition: max-width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        background-color 0.5s, 
                        color 0.5s, 
                        box-shadow 0.5s;
            /* Softer, more "liquid" shadow */
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        #top-nav > div { /* The inner flex container */
            gap: 0;
            /* Springy transition for the gap */
            transition: gap 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .nav-expandable-content {
            max-width: 0px;
            opacity: 0;
            transform: translateX(-20px);
            overflow: hidden;
            /* Springy and delayed for content */
            transition: max-width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s, 
                        opacity 0.4s ease 0.2s, /* Fade in slightly after */
                        transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s;
            white-space: nowrap;
        }

        #top-nav:hover {
            max-width: 800px; /* Increased to ensure all content fits */
        }
        #top-nav:hover > div {
            gap: 1.5rem; /* This was gap-6 */
        }
        #top-nav:hover .nav-expandable-content {
            max-width: 600px; /* Increased to ensure all content fits */
            opacity: 1;
            transform: translateX(0);
        }

        html.dark #top-nav, html.red-verse-theme #top-nav {
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* --- Google Sign In Button --- */
        .google-signin-btn {
            background-color: #FFFFFF;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.1);
            display: flex; /* To center the SVG */
            align-items: center;
            justify-content: center;
        }
        .google-signin-btn:hover {
            background-color: #f8f8f8;
            box-shadow: 0 2px 4px 0 rgba(0,0,0,0.15);
        }
        
        /* --- Auth Buttons --- */
        #nav-auth #login-btn { display: inline-block; }
        #nav-auth #user-info,
        #nav-auth #logout-btn { display: none; }
        
        #nav-auth.signed-in #login-btn { display: none; }
        #nav-auth.signed-in #user-info,
        #nav-auth.signed-in #logout-btn { display: inline-block; }
        
        /* --- Form Fields --- */
        .feedback-form-field {
            background-color: transparent;
            border: 2px solid var(--c-accent-2);
            color: var(--c-text);
            --tw-ring-color: var(--c-accent-1);
        }
        .feedback-form-field:focus {
            border-color: var(--c-accent-1);
            box-shadow: 0 0 0 2px var(--c-accent-1);
            outline: none;
        }
        
        /* --- Admin Panel Styles --- */
        .admin-input {
            background-color: var(--c-bg);
            border: 2px solid var(--c-accent-2);
            color: var(--c-text);
            --tw-ring-color: var(--c-accent-1);
        }
        .admin-input:focus {
            border-color: var(--c-accent-1);
            box-shadow: 0 0 0 2px var(--c-accent-1);
            outline: none;
        }
        /* Special override for admin panel when not in light mode */
        html.dark .admin-input, html.red-verse-theme .admin-input {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
            color: #f3f4f6; /* gray-100 */
        }
        
        .admin-tab {
            opacity: 0.6;
            border-bottom: 3px solid transparent;
            transform: translateY(3px);
        }
        .admin-tab.admin-tab-active {
            opacity: 1;
            border-bottom-color: var(--c-accent-1);
        }
        
        .admin-data-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .admin-data-list > div:nth-child(even) {
            background-color: rgba(128, 128, 128, 0.05);
        }

        /* --- Comment Replies --- */
        .replies-container {
            border-left: 2px solid var(--c-accent-2);
        }

    </style>
</head>
<body class="font-body">

    <!-- STICKY NAV -->
    <nav id="top-nav" class="fixed top-0 left-1/2 -translate-x-1/2 py-3 px-6 z-50 mt-4 rounded-full shadow-lg">
        <div class="mx-auto flex justify-between items-center gap-6">
            <a href="#about" class="font-headline text-2xl font-bold whitespace-nowrap" style="color: var(--c-accent-1);">Timeless Whispers</a>
            <div class="flex items-center gap-4 md:gap-6 nav-expandable-content">
                <a href="#journal" class="font-body text-sm hover:text-[var(--c-highlight)] transition-colors">Journal</a>
                <a href="#gallery" class="font-body text-sm hover:text-[var(--c-highlight)] transition-colors">Gallery</a>
                <a href="#connect" class="font-body text-sm hover:text-[var(--c-highlight)] transition-colors">Connect</a>
                <a href="#admin" id="admin-link" class="font-body text-sm hover:text-[var(--c-highlight)] transition-colors hidden font-bold" style="color: var(--c-highlight);">Admin</a>
                <div id="nav-auth" class="flex items-center gap-2 md:gap-4 pl-2 md:pl-4 border-l" style="border-color: var(--c-accent-2);">
                    <span id="user-info" class="text-sm">
                        <span id="user-name" class="font-bold"></span>
                    </span>
                    <button id="login-btn" class="google-signin-btn p-2.5 rounded-full text-sm transition-all whitespace-nowrap">
                        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" viewBox="0 0 48 48">
                          <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
                          <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
                          <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
                          <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.2-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
                          <path fill="none" d="M0 0h48v48H0z"></path>
                        </svg>
                    </button>
                    <button id="logout-btn" class="font-bold text-sm opacity-70 hover:opacity-100">Sign Out</button>
                </div>
            </div>
        </div>
    </nav>

    <main>
        
        <!-- ABOUT ME (CINEMATIC HERO) -->
        <section id="about" class="min-h-screen flex items-center justify-center relative p-8 text-center text-white" style="background-image: url('https://images.unsplash.com/photo-1455390582262-044cdead277a?q=80&w=1973&auto=format=fit=crop'); background-size: cover; background-position: center; background-color: var(--dark-bg);">
            <div class="absolute inset-0 bg-black/60 z-10"></div>
            <div class="relative z-20 max-w-3xl mx-auto px-4 fade-in-up">
                 <h2 class="font-headline text-5xl md:text-7xl font-bold" style="color: var(--dark-highlight)">This is me, unfiltered.</h2>
                 <p class="mt-6 opacity-90 leading-relaxed text-lg md:text-xl">I’m Max A wordsmith on a mission to turn life into poetry! Every line I write is fueled by love, heartbreak, and the crazy twists and turns of this beautiful chaos we call life.<br><br>I don’t just write poems; I create moments, feelings, and stories that stick with you. Whether it’s finding light in the dark or chasing dreams that set your soul on fire, my poetry is here to vibe with yours.<br><br>Dive in, feel the rhythm, and let’s turn life into poetry together!</p>
                 <a href="#gallery" class="inline-block mt-8 font-bold text-lg transition-colors duration-300 border-2 py-3 px-6 rounded-full" style="border-color: var(--dark-accent-1); color: var(--dark-accent-1); backdrop-filter: blur(5px);">
                   [ Read the Collection ]
                 </a>
            </div>
        </section>

        <!-- POET'S JOURNAL (INTERLUDE) -->
        <section id="journal" class="min-h-screen py-20 px-4 md:px-8 flex items-center justify-center" style="background-color: var(--dark-bg); color: var(--dark-text);">
            <div class="max-w-3xl mx-auto text-center fade-in-up">
                <h2 class="font-headline text-4xl font-bold" style="color: var(--dark-highlight)">Poet’s Journal</h2>
                <p class="mt-2 mb-12 opacity-70">Short writings, reflections, or the stories behind the poems.</p>
                <div class="text-left grid grid-cols-1 gap-12">
                    <div class="border-l-2 pl-6" style="border-color: var(--dark-accent-2)">
                        <h3 class="font-headline text-2xl font-bold" style="color: var(--dark-accent-1)">An Open Book</h3>
                        <p class="mt-2 opacity-80 font-writing text-lg">I write for everyone. There are no "letters I never sent" here, no hidden diaries. My work is an open book, a conversation with the world. Each poem is a piece of my soul, offered freely, hoping to find a connection in yours.</p>
                    </div>
                    <div class="border-l-2 pl-6" style="border-color: var(--dark-accent-2)">
                        <h3 class="font-headline text-2xl font-bold" style="color: var(--dark-accent-1)">On Finding Hope in Chaos</h3>
                        <p class="mt-2 opacity-80 font-writing text-lg">It's easy to write about storms, but what about the first ray of light that breaks through? This is a reflection on capturing that fleeting moment of optimism when all seems lost...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- EMOTION GALLERY -->
        <section id="gallery" class="min-h-screen py-20 px-4 md:px-8 flex items-center">
            <div class="max-w-6xl w-full mx-auto">
                <h2 class="font-headline text-4xl text-center font-bold" style="color: var(--c-highlight)">Read what your heart needs.</h2>
                <div id="category-filters" class="flex flex-wrap justify-center gap-2 md:gap-4 my-8">
                    <!-- Filters will be injected here -->
                </div>
                <div id="poems-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Poem cards will be injected here -->
                </div>
            </div>
        </section>

        <!-- CONNECT / SUBMIT -->
        <section id="connect" class="min-h-screen py-20 px-4 flex items-center justify-center bg-black/5 dark:bg-white/5">
            <div class="max-w-5xl mx-auto w-full">
                <h2 class="font-headline text-3xl font-bold text-center" style="color: var(--c-accent-1)">Join the Conversation</h2>
                <p class="mt-2 mb-12 opacity-70 text-center">Your thoughts and your words are welcome here.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-16">
                    
                    <!-- Left: Leave a Review -->
                    <div>
                        <h3 class="font-headline text-2xl font-bold" style="color: var(--c-highlight)">Leave a Review</h3>
                        <p class="opacity-70 mt-1 mb-4 text-sm">Have feedback? Found a bug? Share your thoughts.</p>
                        <form id="review-form">
                            <textarea id="review-text" name="review" placeholder="Your thoughts..." class="w-full p-3 h-32 rounded-lg focus:ring-2 outline-none transition-shadow feedback-form-field" required></textarea>
                            <button id="post-review-btn" type="submit" class="mt-2 font-bold py-2 px-5 rounded-full shadow-lg hover:opacity-90 transition-all text-sm disabled:opacity-60" style="background-color: var(--c-accent-1); color: var(--c-bg);">Send Feedback</button>
                            <p id="review-message" class="text-sm mt-2 hidden" style="color: var(--c-accent-1);"></p>
                        </form>
                    </div>
                    
                    <!-- Right: Share Your Whisper -->
                    <div>
                        <h3 class="font-headline text-2xl font-bold" style="color: var(--c-highlight)">Share Your Whisper</h3>
                        <p class="opacity-70 mt-1 mb-4 text-sm">Submit your own poem for a chance to be featured.</p>
                        <form id="submission-form">
                            <input id="submission-title" type="text" name="title" placeholder="Poem Title" class="w-full p-3 rounded-lg focus:ring-2 outline-none transition-shadow feedback-form-field" required>
                            <textarea id="submission-content" name="content" placeholder="Your poem..." class="w-full p-3 h-48 mt-2 rounded-lg focus:ring-2 outline-none transition-shadow feedback-form-field" required></textarea>
                            <button id="post-submission-btn" type="submit" class="mt-2 font-bold py-2 px-5 rounded-full shadow-lg hover:opacity-90 transition-all text-sm disabled:opacity-60" style="background-color: var(--c-accent-1); color: var(--c-bg);">Submit Poem</button>
                            <p id="submission-message" class="text-sm mt-2 hidden" style="color: var(--c-accent-1);"></p>
                        </form>
                    </div>
                    
                </div>
            </div>
        </section>
        
        <!-- ADMIN PANEL (Hidden by default) -->
        <section id="admin" class="py-20 px-4 hidden" style="background-color: var(--c-bg);">
            <div class="max-w-4xl mx-auto p-4 md:p-8">
                <h2 class="font-headline text-3xl font-bold text-center mb-8" style="color: var(--c-highlight);">Admin Panel</h2>
                
                <!-- Admin Tabs -->
                <div class="mb-6 border-b" style="border-color: var(--c-accent-2);">
                    <nav class="flex -mb-px space-x-6">
                        <button class="admin-tab admin-tab-active font-medium pb-3" data-tab="dashboard">Dashboard</button>
                        <button class="admin-tab font-medium pb-3" data-tab="add-edit-poem">Add/Edit Poem</button>
                        <button class="admin-tab font-medium pb-3" data-tab="manage-poems">Manage Poems</button>
                        <button class="admin-tab font-medium pb-3" data-tab="moderate-comments">Moderate Comments</button>
                        <button class="admin-tab font-medium pb-3" data-tab="view-submissions">View Submissions</button>
                    </nav>
                </div>

                <!-- Admin Tab Content -->
                <div>
                    <!-- Dashboard -->
                    <div id="content-dashboard" class="admin-tab-content">
                        <h3 class="font-headline text-2xl mb-4" style="color: var(--c-accent-1);">Site Statistics</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 rounded-lg" style="background-color: var(--c-accent-2);">
                                <div class="text-3xl font-bold" id="stat-total-poems">0</div>
                                <div class="text-sm opacity-80">Total Poems</div>
                            </div>
                            <div class="p-4 rounded-lg" style="background-color: var(--c-accent-2);">
                                <div class="text-3xl font-bold" id="stat-total-comments">0</div>
                                <div class="text-sm opacity-80">Total Comments</div>
                            </div>
                            <div class="p-4 rounded-lg" style="background-color: var(--c-accent-2);">
                                <div class="text-3xl font-bold" id="stat-total-users">0</div>
                                <div class="text-sm opacity-80">Total Users</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add/Edit Poem -->
                    <div id="content-add-edit-poem" class="admin-tab-content hidden">
                        <form id="poem-form" class="space-y-4">
                            <h3 id="poem-form-title" class="font-headline text-2xl mb-4" style="color: var(--c-accent-1);">Add a New Poem</h3>
                            <!-- Title -->
                            <div>
                                <label for="poem-title" class="block text-sm font-medium" style="color: var(--c-text);">Title</label>
                                <input type="text" id="poem-title" class="mt-1 block w-full rounded-lg p-3 focus:ring-2 outline-none transition-shadow admin-input" required>
                            </div>

                            <!-- Category -->
                            <div>
                                <label for="poem-emotion" class="block text-sm font-medium" style="color: var(--c-text);">Category (Emotion)</label>
                                <select id="poem-emotion" class="mt-1 block w-full rounded-lg p-3 focus:ring-2 outline-none transition-shadow admin-input" required>
                                    <option value="">Loading categories...</option>
                                    <!-- Categories will be populated here by JS -->
                                </select>
                            </div>
                            
                            <!-- New Category Input -->
                            <div class="pt-4 border-t" style="border-color: var(--c-accent-2);">
                                 <label for="new-category-input" class="block text-sm font-medium" style="color: var(--c-text);">Or Add New Category</label>
                                 <div class="flex gap-2 mt-1">
                                    <input type="text" id="new-category-input" class="block w-full rounded-lg p-3 focus:ring-2 outline-none transition-shadow admin-input" placeholder="e.g. Joy">
                                    <button type="button" id="add-category-btn" class="font-bold py-2 px-5 rounded-full shadow-lg hover:opacity-90 transition-all text-sm whitespace-nowrap" style="background-color: var(--c-accent-1); color: var(--c-bg);">Add</button>
                                 </div>
                            </div>

                            <!-- Content -->
                            <div>
                                <label for="poem-content" class="block text-sm font-medium" style="color: var(--c-text);">Content</label>
                                <textarea id="poem-content" rows="15" class="mt-1 block w-full rounded-lg p-3 focus:ring-2 outline-none transition-shadow admin-input" required></textarea>
                                <p class="text-xs opacity-60 mt-1">Line breaks will be preserved.</p>
                            </div>

                            <!-- Submit Button -->
                            <div class="flex items-center gap-4">
                                <button id="submit-btn" type="submit" class="font-bold py-2 px-5 rounded-full shadow-lg hover:opacity-90 transition-all text-sm disabled:opacity-60" style="background-color: var(--c-accent-1); color: var(--c-bg);">
                                    Submit Poem
                                </button>
                                <svg id="loading-indicator" class="hidden animate-spin h-5 w-5" style="color: var(--c-accent-1);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span id="status-message" class="text-sm hidden"></span>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Manage Poems -->
                    <div id="content-manage-poems" class="admin-tab-content hidden">
                        <h3 class="font-headline text-2xl mb-4" style="color: var(--c-accent-1);">Manage Poems</h3>
                        <div id="admin-poem-list" class="space-y-2 admin-data-list">
                            <!-- Poem list will be populated here by JS -->
                        </div>
                    </div>
                    
                    <!-- Moderate Comments -->
                    <div id="content-moderate-comments" class="admin-tab-content hidden">
                        <h3 class="font-headline text-2xl mb-4" style="color: var(--c-accent-1);">Moderate Comments</h3>
                        <div id="admin-comment-list" class="space-y-4 admin-data-list">
                            <!-- Comment list will be populated here by JS -->
                        </div>
                    </div>
                    
                    <!-- View Submissions -->
                    <div id="content-view-submissions" class="admin-tab-content hidden">
                        <h3 class="font-headline text-2xl mb-4" style="color: var(--c-accent-1);">View User Submissions</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-bold text-lg mb-2">Reviews</h4>
                                <div id="admin-review-list" class="space-y-4 admin-data-list">
                                    <!-- Reviews will be populated here by JS -->
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg mb-2">Poem Submissions</h4>
                                <div id="admin-submission-list" class="space-y-4 admin-data-list">
                                    <!-- Submissions will be populated here by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </section>
        
    </main>

    <!-- FOOTER -->
    <footer class="py-12 text-center border-t" style="border-color: var(--c-accent-2);">
        <div class="flex justify-center gap-6 mb-4">
            <a href="#about" class="hover:text-[var(--c-highlight)] transition-colors">About</a>
            <a href="#journal" class="hover:text-[var(--c-highlight)] transition-colors">Journal</a>
            <a href="#gallery" class="hover:text-[var(--c-highlight)] transition-colors">Poems</a>
            <a href="#connect" class="hover:text-[var(--c-highlight)] transition-colors">Contact</a>
        </div>
        <p class="italic opacity-60">“Some poems aren't just read — they're felt.”</p>
        <p class="text-sm mt-4 opacity-50">&copy; 2025 Timeless Whispers. All Rights Reserved.</p>
    </footer>

    <!-- QUICK PREVIEW MODAL -->
    <div id="quick-preview-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-[60] opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="modal-content w-full max-w-2xl max-h-[80vh] overflow-y-auto p-8 md:p-12 rounded-lg shadow-2xl relative z-[60]" style="background-color: var(--c-bg);">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-2xl opacity-50 hover:opacity-100 transition-opacity" style="color: var(--c-text)">&times;</button>
            <div id="modal-poem-content"></div>
        </div>
    </div>
    
    <!-- RED VERSE PASSWORD MODAL -->
    <div id="red-verse-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-[70] opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="modal-content w-full max-w-lg p-8 md:p-10 rounded-lg shadow-2xl relative" style="background-color: var(--red-bg); color: var(--red-text);">
            <button id="red-verse-close-btn" class="absolute top-4 right-4 text-2xl opacity-50 hover:opacity-100 transition-opacity" style="color: var(--red-text)">&times;</button>
            
            <h2 class="font-headline text-2xl font-bold mb-4" style="color: var(--red-highlight);">Disclaimer</h2>
            <p class="opacity-80 mb-6 font-writing text-lg">
                This is an explicit and intense message. Please read at your own discretion. It's meant to be playful and bold, but I respect your boundaries and comfort. If this isn't something you're into right now, feel free to let me know. Just wanted to share what was on my mind.
            </p>
            
            <div class="mt-4">
                <label for="red-verse-password" class="block text-sm font-medium opacity-70">Enter Password</label>
                <input type="password" id="red-verse-password" class="mt-1 block w-full rounded-lg p-3 focus:ring-2 outline-none transition-shadow" style="background-color: #374151; border-color: #4b5563; color: #f3f4f6; --tw-ring-color: var(--red-highlight);">
                <p id="red-verse-error" class="text-sm mt-2 hidden" style="color: var(--red-highlight);">Incorrect password.</p>
            </div>
            
            <div class="mt-6 flex justify-end gap-4">
                <button id="red-verse-cancel-btn" class="font-bold py-2 px-5 rounded-full text-sm transition-all" style="background-color: transparent; border: 1px solid var(--red-accent-2); color: var(--red-text);">
                    Cancel
                </button>
                <button id="red-verse-submit-btn" class="font-bold py-2 px-5 rounded-full shadow-lg hover:opacity-90 transition-all text-sm" style="background-color: var(--red-accent-1); color: var(--c-bg);">
                    Enter
                </button>
            </div>
        </div>
    </div>

    <!-- THEME TOGGLE BUTTON -->
    <button id="theme-toggle" class="fixed top-6 right-6 w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg z-50" style="background-color: var(--c-accent-2); color: var(--c-text);">
        <!-- Icon will be injected here -->
    </button>
    
</body>
</html>


