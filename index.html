<!--
    *** DEVELOPER NOTE: REFACTORED FOR CANVAS ENVIRONMENT ***
    
    This file has been updated to integrate with the standard
    Firebase services provided in this environment.

    - Authentication:
      Removed Google Sign-In (`signInWithPopup`).
      Replaced with automatic `signInWithCustomToken` (if provided)
      or `signInAnonymously` as per the environment mandate.
      User auth is now handled on page load.

    - Firestore Database Paths:
      All collection and document paths (for users, likes, reflections,
      newsletter) have been updated to use the mandated
      `/artifacts/{appId}/...` structure for security and
      multi-tenancy.

    - "Save" Feature Consolidation:
      Removed the `localStorage`-based "Favorite" (‚ô•) feature.
      Consolidated all logic into the Firestore-based "Save" (‚≠ê) feature.
      The "Favorites" filter is now "Saved" and reads from the user's
      Firestore document, making it persistent.
      
    - Theme Transition (11/07/2025):
      Removed inline styles from JS render functions.
      Added CSS classes for all themed elements.
      Added global CSS transitions for smooth theme toggling.
      Simplified `toggleTheme()` function.
-->
<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeless Whispers</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900&family=Lora:ital,wght@0,400..700;1,400..700&family=Raleway:wght@300;400;500&family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
      import { 
        getAuth, 
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup,
        signOut
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { 
        getFirestore, 
        collection, 
        addDoc, 
        query, 
        where, 
        getDocs, 
        doc, 
        getDoc, 
        setDoc, 
        serverTimestamp,
        updateDoc,
        arrayUnion,
        arrayRemove,
        setLogLevel
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- MANDATED FIREBASE CONFIG ---
      // Use environment variables provided by the platform.
      const firebaseConfig = typeof __firebase_config !== 'undefined' 
        ? JSON.parse(__firebase_config) 
        : { apiKey: "FALLBACK_API_KEY", authDomain: "FALLBACK_AUTH_DOMAIN", projectId: "FALLBACK_PROJECT_ID" }; // Fallback for local dev

      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      setLogLevel('Debug'); // Enable Firestore logging
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- PAGE SCRIPT ---
      document.addEventListener('DOMContentLoaded', () => {
        
        // --- DATA & CONSTANTS ---
        let poems = []; // Poems will be loaded from Firestore
        // "Favorites" is now "Saved" and reads from Firestore
        const emotions = ['All', 'Saved', 'Love', 'Loss', 'Hope', 'Healing', 'Chaos', 'Silent Nights'];
        
        // --- STATE MANAGEMENT ---
        let currentTheme = 'light';
        let activeFilter = 'All';
        let userSavedPoemIds = []; // Synced from Firestore
        let currentOpenPoemId = null;
        let currentUserId = null;
        let isAuthReady = false;

        // --- DOM ELEMENTS ---
        const docElement = document.documentElement;
        const body = document.body;
        const topNav = document.getElementById('top-nav');
        const emotionFiltersContainer = document.getElementById('emotion-filters');
        const poemsGrid = document.getElementById('poems-grid');
        const modal = document.getElementById('quick-preview-modal');
        const modalContent = document.getElementById('modal-poem-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const themeToggleButton = document.getElementById('theme-toggle');
        
        // Auth DOM Elements
        const navAuth = document.getElementById('nav-auth');
        const userName = document.getElementById('user-name');
        const adminLink = document.getElementById('admin-link');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const signOutBtn = document.getElementById('signout-btn');

        // --- SVG ICONS ---
        const SunIcon = `<svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m4.93 19.07 1.41-1.41"></path><path d="m17.66 6.34 1.41-1.41"></path></svg>`;
        const MoonIcon = `<svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>`;
        const ShareIcon = `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>`;

        // --- RENDER FUNCTIONS ---
        
        function renderFilters() {
            if (!emotionFiltersContainer) return;
            emotionFiltersContainer.innerHTML = emotions.map(emotion => `
                <button data-filter="${emotion}" class="filter-btn py-2 px-5 rounded-full text-sm transition-all duration-300 ${activeFilter === emotion ? 'active' : 'inactive'}">
                    ${emotion}
                </button>
            `).join('');
            emotionFiltersContainer.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    activeFilter = btn.dataset.filter;
                    renderFilters();
                    renderPoemsGrid();
                });
            });
        }

        async function loadPoemsFromFirestore() {
            poems = []; // Clear existing poems
            const poemsRef = collection(db, "artifacts", appId, "public", "data", "poems");
            try {
                const querySnapshot = await getDocs(poemsRef);
                querySnapshot.forEach((doc) => {
                    poems.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Loaded ${poems.length} poems from Firestore.`);
            } catch (e) {
                console.error("Error loading poems: ", e);
                if (poemsGrid) {
                    poemsGrid.innerHTML = `<p class="col-span-full text-center opacity-70 text-red-500">Error: Could not load poems. Check permissions.</p>`;
                }
            }
        }

        function renderPoemsGrid() {
            if (!poemsGrid) return;
            
            // If user is not logged in and poems are empty, show sign in prompt
            if (!currentUserId && poems.length === 0) {
                 poemsGrid.innerHTML = `<p class="col-span-full text-center opacity-70">Please sign in to browse the poem collection.</p>`;
                 return;
            }

            let filteredPoems;
            if (activeFilter === 'All') {
                filteredPoems = poems;
            } else if (activeFilter === 'Saved') {
                // Use Firestore-backed userSavedPoemIds array
                filteredPoems = poems.filter(p => userSavedPoemIds.includes(p.id.toString()));
            } else {
                filteredPoems = poems.filter(p => p.emotion === activeFilter);
            }
            
            if (filteredPoems.length === 0 && activeFilter === 'Saved') {
                poemsGrid.innerHTML = `<p class="col-span-full text-center opacity-70">You haven't saved any poems yet. Sign in to save poems across devices.</p>`;
                return;
            }
            
            if (filteredPoems.length === 0 && activeFilter === 'All') {
                poemsGrid.innerHTML = `<p class="col-span-full text-center opacity-70">No poems found. An admin can add some!</p>`;
                return;
            }

            poemsGrid.innerHTML = filteredPoems.map(poem => `
                <div class="poem-card p-6 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div class="cursor-pointer flex-grow" data-poem-id="${poem.id}">
                            <h3 class="font-headline text-xl font-bold themed-accent-1">${poem.title}</h3>
                            <p class="mt-2 opacity-70 italic">"${poem.content.split('\n')[0]}"</p>
                            <p class="opacity-70 italic">"${poem.content.split('\n')[1]}"</p>
                        </div>
                        <!-- Removed the localStorage-based "favorite" (heart) button -->
                    </div>
                </div>
            `).join('');

            poemsGrid.querySelectorAll('.poem-card > div > div').forEach(card => {
                card.addEventListener('click', () => showPoemModal(card.dataset.poemId));
            });
        }

        function showPoemModal(poemId) {
            const poem = poems.find(p => p.id == poemId);
            if (poem) {
                currentOpenPoemId = poem.id; // Set current poem ID

                modalContent.innerHTML = `
                    <div class="flex justify-between items-start gap-4">
                        <div>
                            <h2 class="font-headline text-3xl font-bold mb-2 themed-highlight">${poem.title}</h2>
                            ${poem.subtitle ? `<p class="italic opacity-60 mb-8">${poem.subtitle}</p>` : '<div class="mb-8"></div>'}
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-4">
                            <!-- Share Button -->
                            <button id="shareButton" onclick="sharePoem()" class="modal-header-btn flex items-center gap-1 py-1 px-2 rounded-full text-sm transition-all duration-300 opacity-70 hover:opacity-100">
                                ${ShareIcon} Share
                            </button>
                            <!-- Save Button (Consolidated) -->
                            <button id="saveButton" class="modal-header-btn py-1 px-2 rounded-full text-sm transition-all duration-300">
                                ‚≠ê Save
                            </button>
                            <!-- Like Button and Count -->
                            <div class="flex items-center gap-1 opacity-80">
                                <button id="likeButton" onclick="likePost()" class="modal-header-btn py-1 px-2 rounded-full text-sm transition-all duration-300">
                                    ‚ù§Ô∏è Like
                                </button>
                                <span id="likeCount" class="modal-like-count text-sm font-bold">0</span>
                            </div>
                            <!-- Removed the "favorite" (heart) button from modal -->
                        </div>
                    </div>
                    <div class="whitespace-pre-wrap leading-relaxed">${poem.content.replace(/\n/g, '<br>')}</div>
                    
                    <!-- Reflections Section -->
                    <div class="mt-12 pt-8 border-t themed-accent-2-border">
                        <h3 class="font-headline text-xl font-bold mb-4 modal-reflections-title">Reflections</h3>
                        
                        <!-- Comment Form -->
                        <div id="comment-form-container" class="mb-6">
                            <p id="comment-signin-prompt" class="hidden opacity-70 modal-comment-prompt">
                                Please wait... loading user info.
                            </p>
                            <div id="comment-form" class="hidden">
                                <textarea id="comment" placeholder="Your thoughts..." class="modal-comment-textarea w-full p-3 h-24 rounded-lg border-2 focus:ring-2 outline-none transition-shadow"></textarea>
                                <button onclick="postComment()" class="modal-comment-post-btn mt-2 font-bold py-2 px-5 rounded-full shadow-lg hover:opacity-90 transition-all text-sm">Post</button>
                            </div>
                        </div>
                        
                        <!-- Comment List -->
                        <div id="list" class="space-y-4 max-h-60 overflow-y-auto">
                            <!-- Comments will be loaded here -->
                        </div>
                    </div>
                `;
                modal.classList.add('visible');
                
                // Check auth state for comment form
                checkAuthForComments(auth.currentUser);
                // Load comments for this poem
                loadComments(poem.id);
                // Load likes for this poem
                loadLikes(poem.id);
                // Load save status for this poem
                updateModalSaveStatus(poem.id);
            }
        }

        function renderThemeToggle() {
            themeToggleButton.innerHTML = currentTheme === 'light' ? MoonIcon : SunIcon;
        }

        // --- CORE LOGIC ---
        function toggleTheme() {
            // Simply toggle the class on the root element. CSS handles the rest.
            docElement.classList.toggle('dark');
            docElement.classList.toggle('light');
            currentTheme = docElement.classList.contains('dark') ? 'dark' : 'light';
            
            // Only need to re-render the icon
            renderThemeToggle();
        }

        // --- AUTH FUNCTIONS (MANDATED) ---

        async function googleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Google Sign-In Error:", error);
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                await saveUser(user); // Ensure user doc exists

                const userDisplayName = user.displayName || `User...${user.uid.slice(-4)}`;
                userName.textContent = `Hi, ${userDisplayName}`;
                userName.classList.remove('hidden');
                signOutBtn.classList.remove('hidden');
                googleSignInBtn.classList.add('hidden');
                
                // Check for admin role
                try {
                    const userRef = doc(db, "artifacts", appId, "users", user.uid);
                    const docSnap = await getDoc(userRef);
                    
                    if (docSnap.exists() && docSnap.data().role === "admin") {
                        adminLink.classList.remove('hidden');
                    } else {
                        adminLink.classList.add('hidden');
                    }
                } catch (e) {
                    console.error("Error checking admin role: ", e);
                    adminLink.classList.add('hidden');
                }
                
                // Load user-specific data
                await loadUserSavedPoems(user.uid);
                
                // --- FIX: Load poems *after* auth is confirmed ---
                await loadPoemsFromFirestore();
                renderFilters();
                renderPoemsGrid();

            } else {
                // User is signed out
                currentUserId = null;
                userName.classList.add('hidden');
                signOutBtn.classList.add('hidden');
                googleSignInBtn.classList.remove('hidden');
                adminLink.classList.add('hidden');
                
                // --- FIX: Clear data and show sign-in prompt ---
                poems = []; // Clear poems
                userSavedPoemIds = []; // Clear saved poems
                
                renderFilters(); // Render filters (e.g., "Saved" will be empty)
                renderPoemsGrid(); // Re-render grid (will show sign-in prompt)
            }
            
            isAuthReady = true;
            
            // Update comment form visibility if modal is open
            checkAuthForComments(user);
            
            // Re-load likes/saves to check user's status
            if(currentOpenPoemId) {
                loadLikes(currentOpenPoemId);
                updateModalSaveStatus(currentOpenPoemId);
            }
        });

        async function saveUser(u){
            if (!u || !u.uid) return;
            // Use mandated path
            const userRef = doc(db, "artifacts", appId, "users", u.uid);
            try {
                const docSnap = await getDoc(userRef);
                if (!docSnap.exists()) {
                    // Create new user doc
                    await setDoc(userRef, {
                        uid: u.uid,
                        displayName: u.displayName || 'Anonymous',
                        email: u.email || null,
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp(),
                        savedPoems: []
                    });
                } else {
                    // Update existing user's last login
                    await updateDoc(userRef, {
                        lastLogin: serverTimestamp()
                    });
                }
            } catch (e) {
                console.error("Error saving user:", e);
            }
        }

        // --- SHARE FUNCTION ---
        window.sharePoem = function() {
            const poem = poems.find(p => p.id == currentOpenPoemId);
            if (!poem) return;
            
            // Use a modal alert for environments where confirm() is blocked
            const showTempAlert = (message) => {
                let alertBox = document.getElementById('temp-alert');
                if (!alertBox) {
                    alertBox = document.createElement('div');
                    alertBox.id = 'temp-alert';
                    alertBox.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-white text-black p-4 rounded-lg shadow-lg z-[100] transition-all duration-300 opacity-0';
                    document.body.appendChild(alertBox);
                }
                alertBox.textContent = message;
                alertBox.style.opacity = '1';
                setTimeout(() => {
                    alertBox.style.opacity = '0';
                }, 2000);
            };

            if (navigator.share) {
                navigator.share({
                    title: poem.title,
                    text: `Check out this poem by Max: "${poem.title}"`,
                    url: window.location.href // Shares the main site URL
                })
                .then(() => console.log('Successful share'))
                .catch((error) => console.log('Error sharing', error));
            } else {
                // Fallback for environments without navigator.share
                try {
                    const textToCopy = `Check out "${poem.title}" on Timeless Whispers:\n${window.location.href}`;
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    textArea.style.position = "fixed"; //- Remove from old document flow
                    textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showTempAlert("Link copied to clipboard!");
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    showTempAlert("Could not copy link.");
                }
            }
        }


        // --- LIKE FUNCTIONS ---
        
        // Custom confirm modal to avoid blocked window.confirm()
        function showCustomConfirm(message, callback) {
            let confirmBox = document.getElementById('custom-confirm');
            if (confirmBox) confirmBox.remove(); // Remove old one if exists

            confirmBox = document.createElement('div');
            confirmBox.id = 'custom-confirm';
            confirmBox.className = 'fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[90]';
            confirmBox.innerHTML = `
                <div class="modal-content p-6 rounded-lg shadow-xl max-w-sm w-full">
                    <p class="text-lg mb-4">${message}</p>
                    <div class="flex justify-end gap-4">
                        <button id="confirm-cancel" class="font-bold py-2 px-4 rounded-full transition-all themed-accent-2-border border">Cancel</button>
                        <button id="confirm-ok" class="font-bold py-2 px-4 rounded-full shadow-lg hover:opacity-90 transition-all themed-accent-1-bg themed-bg">Sign In</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirm-ok').onclick = () => {
                callback(true);
                document.body.removeChild(confirmBox);
            };
            document.getElementById('confirm-cancel').onclick = () => {
                callback(false);
                document.body.removeChild(confirmBox);
            };
            confirmBox.onclick = (e) => {
                 if (e.target.id === 'custom-confirm') {
                    callback(false);
                    document.body.removeChild(confirmBox);
                 }
            };
        }


        window.likePost = async function() {
            if (!currentUserId) {
                // User not signed in, prompt to sign in
                showCustomConfirm("Please sign in to like this post. Would you like to sign in now?", (didConfirm) => {
                    if (didConfirm) {
                        googleSignIn();
                    }
                });
                return;
            }
            if (!currentOpenPoemId) {
                console.error("No poem ID is set.");
                return;
            }

            const likeButton = document.getElementById("likeButton");
            likeButton.disabled = true; // Disable to prevent spam

            const poemIdStr = currentOpenPoemId.toString();
            
            // Use mandated path
            const likesRef = collection(db, "artifacts", appId, "public", "data", "likes");
            const q = query(likesRef, where("poemId", "==", poemIdStr), where("userId", "==", currentUserId));

            try {
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    console.log("You have already liked this post.");
                    likeButton.textContent = "‚ù§Ô∏è Liked";
                    return; // Already liked
                }

                // User hasn't liked it, so add a new like document
                await addDoc(likesRef, {
                    poemId: poemIdStr,
                    userId: currentUserId,
                    timestamp: serverTimestamp()
                });

                // Manually refresh the count
                loadLikes(currentOpenPoemId);
                likeButton.textContent = "‚ù§Ô∏è Liked";

            } catch (e) {
                console.error("Error liking post: ", e);
                likeButton.disabled = false; // Re-enable on error
            }
        }

        window.loadLikes = async function(poemId) {
            const likeCountSpan = document.getElementById("likeCount");
            const likeButton = document.getElementById("likeButton");
            if (!likeCountSpan || !likeButton) return;

            const poemIdStr = poemId.toString();
            // Use mandated path
            const likesRef = collection(db, "artifacts", appId, "public", "data", "likes");
            const q = query(likesRef, where("poemId", "==", poemIdStr));

            try {
                // 1. Get the total like count
                const querySnapshot = await getDocs(q);
                likeCountSpan.textContent = querySnapshot.size;

                // 2. Check user's like status
                if (currentUserId) {
                    const userLikeQuery = query(likesRef, where("poemId", "==", poemIdStr), where("userId", "==", currentUserId));
                    const userLikeSnap = await getDocs(userLikeQuery);
                    
                    if (!userLikeSnap.empty) {
                        likeButton.disabled = true;
                        likeButton.textContent = "‚ù§Ô∏è Liked";
                    } else {
                        likeButton.disabled = false;
                        likeButton.textContent = "‚ù§Ô∏è Like";
                    }
                } else {
                    likeButton.disabled = true;
                    likeButton.textContent = "‚ù§Ô∏è Like"; // Show "Like" but disabled
                }

            } catch (e) {
                console.error("Error loading like count: ", e);
            }
        }

        // --- SAVE FUNCTIONS (Consolidated) ---
        
        async function loadUserSavedPoems(uid) {
            if (!uid) {
                userSavedPoemIds = [];
                renderPoemsGrid();
                return;
            }
            // Use mandated path
            const userRef = doc(db, "artifacts", appId, "users", uid);
            try {
                const docSnap = await getDoc(userRef);
                if (docSnap.exists() && docSnap.data().savedPoems) {
                    userSavedPoemIds = docSnap.data().savedPoems;
                } else {
                    userSavedPoemIds = [];
                }
            } catch (e) {
                console.error("Error loading user's saved poems: ", e);
                userSavedPoemIds = [];
            }
            
            // Re-render grid in case "Saved" filter is active
            renderPoemsGrid();
        }

        window.toggleSavePoem = async function(poemIdStr) {
            if (!currentUserId) {
                // User not signed in, prompt to sign in
                showCustomConfirm("Please sign in to save this post. Would you like to sign in now?", (didConfirm) => {
                     if (didConfirm) {
                        googleSignIn();
                    }
                });
                return;
            }
            if (!poemIdStr) {
                console.error("No poem ID is set.");
                return;
            }

            const saveButton = document.getElementById("saveButton");
            if (saveButton) saveButton.disabled = true; // Disable to prevent spam

            // Use mandated path
            const userRef = doc(db, "artifacts", appId, "users", currentUserId);
            const isSaved = userSavedPoemIds.includes(poemIdStr);

            try {
                if (isSaved) {
                    // Unsave it
                    await updateDoc(userRef, {
                        savedPoems: arrayRemove(poemIdStr)
                    });
                    userSavedPoemIds = userSavedPoemIds.filter(id => id !== poemIdStr);
                    console.log("Poem Unsaved ‚úÖ");
                } else {
                    // Save it
                    await updateDoc(userRef, {
                        savedPoems: arrayUnion(poemIdStr)
                    });
                    userSavedPoemIds.push(poemIdStr);
                    console.log("Poem Saved ‚úÖ");
                }
            } catch (e) {
                console.error("Error toggling save state: ", e);
            }
            
            // Update UI
            updateModalSaveStatus(poemIdStr); // Update button text
            renderPoemsGrid(); // Update grid (for "Saved" filter)
        }

        function updateModalSaveStatus(poemId) {
            const saveButton = document.getElementById("saveButton");
            if (!saveButton) return;

            const poemIdStr = poemId.toString();
            const isSaved = userSavedPoemIds.includes(poemIdStr);
            
            if (isAuthReady) {
                if (currentUserId) {
                    saveButton.disabled = false;
                    saveButton.textContent = isSaved ? "‚≠ê Saved" : "‚≠ê Save";
                    // Set/update click handler
                    saveButton.onclick = () => toggleSavePoem(poemIdStr);
                } else {
                    saveButton.disabled = true;
                    saveButton.textContent = "‚≠ê Save"; // Show "Save" but disabled
                    saveButton.onclick = () => {
                        showCustomConfirm("Please sign in to save this post. Would you like to sign in now?", (didConfirm) => {
                             if (didConfirm) {
                                googleSignIn();
                            }
                        });
                    };
                }
            } else {
                saveButton.disabled = true;
                saveButton.textContent = "‚≠ê Loading...";
            }
        }


        // --- COMMENT FUNCTIONS ---
        
        function checkAuthForComments(user) {
            const commentForm = document.getElementById('comment-form');
            const signinPrompt = document.getElementById('comment-signin-prompt');
            if (!commentForm || !signinPrompt) return; // Modal not open

            if (isAuthReady) {
                if (user) {
                    commentForm.classList.remove('hidden');
                    signinPrompt.classList.add('hidden');
                } else {
                    // User is signed out
                    commentForm.classList.add('hidden');
                    signinPrompt.innerHTML = `Please <button id="modal-signin-btn" class="font-bold underline hover:opacity-70 transition-opacity">sign in</button> to leave a reflection.`;
                    signinPrompt.classList.remove('hidden');
                    
                    const modalSignInBtn = document.getElementById('modal-signin-btn');
                    if(modalSignInBtn) {
                        modalSignInBtn.onclick = googleSignIn;
                    }
                }
            } else {
                // Auth is not ready yet
                commentForm.classList.add('hidden');
                signinPrompt.textContent = "Loading user info...";
                signinPrompt.classList.remove('hidden');
            }
        }

        window.postComment = async function(){
            const user = auth.currentUser;
            if(!user || !currentUserId) {
                console.error("User not authenticated!");
                checkAuthForComments(null); // Show sign-in prompt
                return;
            }
            if(!currentOpenPoemId) {
                console.error("No poem ID selected.");
                return;
            }

            let textEl = document.getElementById("comment");
            let text = textEl.value;
            if (!text.trim()) return; // Don't post empty comments
            
            const userNameForComment = user.isAnonymous ? 'Anonymous' : (user.displayName || `User...${user.uid.slice(-4)}`);

            try {
                // Use mandated path
                await addDoc(collection(db, "artifacts", appId, "public", "data", "reflections"), {
                    poemId: currentOpenPoemId.toString(),
                    userId: currentUserId,
                    userName: userNameForComment,
                    text: text,
                    parentId: null,
                    createdAt: serverTimestamp()
                });
                
                console.log("Comment posted!");
                textEl.value = ""; // Clear textarea
                loadComments(currentOpenPoemId); // Refresh comments
            } catch (e) {
                console.error("Error posting comment: ", e);
            }
        };
        
        window.loadComments = async function(poemId){
            const list = document.getElementById('list');
            if (!list) return; // Exit if modal isn't open
            list.innerHTML = "<p class='opacity-50'>Loading reflections...</p>";
            
            try {
                // Use mandated path
                const q = query(collection(db, "artifacts", appId, "public", "data", "reflections"), where("poemId", "==", poemId.toString()));
                const querySnapshot = await getDocs(q);
                
                let comments = [];
                querySnapshot.forEach(doc => {
                    comments.push(doc.data());
                });

                // Sort by time, newest first (if time is null, put at end)
                comments.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                renderComments(comments);
                
            } catch (e) {
                console.error("Error loading comments: ", e);
                list.innerHTML = "<p class='modal-comment-error'>Error loading reflections.</p>";
            }
        }

        function renderComments(comments) {
            const list = document.getElementById('list');
            if (!list) return;

            if (comments.length === 0) {
                list.innerHTML = "<p class='opacity-50'>Be the first to leave a reflection.</p>";
                return;
            }
            
            list.innerHTML = comments.map(c => {
                const time = c.createdAt ? new Date(c.createdAt.seconds * 1000).toLocaleString() : 'Just now';
                // Sanitize display name just in case
                const displayName = c.userName ? c.userName.replace(/<[^>]*>?/gm, '') : 'Anonymous';
                // Sanitize text
                const commentText = c.text ? c.text.replace(/<[^>]*>?/gm, '') : '';
                
                return `
                    <div class="border-l-2 pl-3 modal-comment-item">
                        <p class="leading-relaxed">${commentText}</p>
                        <p class="text-sm opacity-60 mt-1">
                            <strong>${displayName}</strong> ‚Äì <span class="text-xs">${time}</span>
                        </p>
                    </div>
                `;
            }).join('');
        }
        
        // --- SUBSCRIBE FUNCTION ---
        window.subscribe = async function(){
            const emailEl = document.getElementById('email');
            const email = emailEl.value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!email || !emailRegex.test(email)) {
                console.warn("Invalid email.");
                emailEl.style.borderColor = 'red'; // Add visual feedback for invalid email
                return;
            }
            
            emailEl.style.borderColor = 'var(--c-accent-2)'; // Reset border color

            try {
                // Use mandated path
                await addDoc(collection(db, "artifacts", appId, "public", "data", "newsletter"), {
                    email: email,
                    subscribedAt: serverTimestamp()
                });
                
                // Hide form, show thanks
                document.getElementById('subscribe-form').classList.add('hidden');
                document.getElementById('subscribe-thanks').classList.remove('hidden');
                console.log("Subscribed ‚úÖ");
                
            } catch (e) {
                console.error("Error subscribing: ", e);
                // Optionally show an error message to the user
            }
        }

        // --- EVENT LISTENERS ---
        modalCloseBtn.addEventListener('click', () => {
            modal.classList.remove('visible');
            renderPoemsGrid(); // Re-render grid to reflect any state changes
            currentOpenPoemId = null;
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('visible');
                renderPoemsGrid();
                currentOpenPoemId = null;
            }
        });
        
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetElement = document.querySelector(this.getAttribute('href'));
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth'
                    });
                }
            }); 
        });
        
        window.addEventListener('scroll', () => {
            if (window.scrollY > 50) {
                topNav.classList.add('scrolled');
            } else {
                topNav.classList.remove('scrolled');
            }
        });
        
        // --- FIX: Add listeners for new auth buttons ---
        if (googleSignInBtn) googleSignInBtn.addEventListener('click', googleSignIn);
        if (signOutBtn) signOutBtn.addEventListener('click', signOutUser);


        // --- INITIALIZATION ---
        async function init() {
            // Auth is now handled by onAuthStateChanged listener.
            // We need to render the initial state for a logged-out user.
            renderFilters();
            renderPoemsGrid(); // This will show the "Please sign in" message
            
            // Only render theme toggle, as it's independent of data/auth
            renderThemeToggle();
            if (themeToggleButton) {
                themeToggleButton.addEventListener('click', toggleTheme);
            }
        }

        init();
      });
    </script>

    <style>
        /* --- Custom Styles & Theming --- */
        :root {
            /* ‚òÄÔ∏è Light Mode: ‚ÄúEarthbound Elegance‚Äù */
            --light-bg: #FFF9F2;
            --light-text: #3B2F2F;
            --light-accent-1: #A67C52;
            --light-accent-2: #D4BFAA;
            --light-highlight: #6B4226;

            /* üåô Dark Mode: ‚ÄúSepia Eclipse‚Äù */
            --dark-bg: #1C1A18;
            --dark-text: #E8DCCF;
            --dark-accent-1: #A67C52;
            --dark-accent-2: #533C2C;
            --dark-highlight: #E2B27E;
            
            --c-bg: var(--light-bg);
            --c-text: var(--light-text);
            --c-accent-1: var(--light-accent-1);
            --c-accent-2: var(--light-accent-2);
            --c-highlight: var(--light-highlight);
        }

        html.dark {
             --c-bg: var(--dark-bg);
             --c-text: var(--dark-text);
             --c-accent-1: var(--dark-accent-1);
             --c-accent-2: var(--dark-accent-2); 
             --c-highlight: var(--dark-highlight);
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--c-bg);
            color: var(--c-text);
            /* transition: background-color 0.5s, color 0.5s; -- REMOVED */
        }

        /* --- Global Transitions --- */
        /* Apply smooth transitions to all elements that change on theme toggle */
        body, button, a, input, textarea, nav, footer,
        .poem-card, .modal-content, .filter-btn,
        #top-nav.scrolled {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        /* Handle SVG fill/stroke */
        svg {
            transition: fill 0.3s ease, stroke 0.3s ease;
        }


        /* --- Font Families --- */
        .font-headline { font-family: 'Playfair Display', serif; }
        .font-body { font-family: 'Raleway', sans-serif; }
        .font-name { font-family: 'Cinzel Decorative', serif; }
        .font-writing { font-family: 'Lora', serif; }

        /* --- Animations --- */
        @keyframes fade-in-up { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .fade-in-up { 
            animation: fade-in-up 0.8s ease-out forwards; 
            opacity: 0;
        }
        .fade-in-up-delay-1 { animation-delay: 0.2s; }
        .fade-in-up-delay-2 { animation-delay: 0.4s; }
        .fade-in-up-delay-3 { animation-delay: 0.6s; }

        /* --- Theme Transition --- */
        /* body.theme-transition { ... } -- REMOVED */
        
        /* --- Gallery Card --- */
        .poem-card {
            /* transition: transform 0.3s ease, box-shadow 0.3s ease; -- Handled by global */
            background-color: var(--c-bg);
            border: 1px solid var(--c-accent-2);
        }
        .poem-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        html.dark .poem-card:hover {
             box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        /* --- Filter Buttons --- */
        .filter-btn.active {
            background-color: var(--c-accent-1);
            border-color: var(--c-accent-1);
            color: var(--c-bg);
        }
        .filter-btn.inactive {
            border: 1px solid var(--c-accent-2);
            color: var(--c-text);
        }

        /* --- Modal --- */
        .modal-content {
            background-color: var(--c-bg);
        }
        #modal-close-btn {
            color: var(--c-text);
        }
        #quick-preview-modal {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #quick-preview-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #quick-preview-modal .modal-content {
            transition: transform 0.4s ease-out, background-color 0.3s ease, color 0.3s ease; /* Keep transform transition */
            transform: scale(0.95);
        }
        #quick-preview-modal.visible .modal-content {
            transform: scale(1);
        }
        
        /* --- Sticky Nav --- */
        #top-nav {
            background-color: transparent;
            /* transition: background-color 0.3s ease; -- Handled by global */
        }
        #top-nav.scrolled {
            background-color: var(--c-bg);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        html.dark #top-nav.scrolled {
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        /* --- Auth Buttons (Simplified) --- */
        #nav-auth #user-info { 
            display: inline-block; 
        }

        /* --- Themed Elements --- */
        /* Classes to replace inline styles */
        .themed-bg { background-color: var(--c-bg); }
        .themed-text { color: var(--c-text); }
        .themed-accent-1 { color: var(--c-accent-1); }
        .themed-accent-1-bg { background-color: var(--c-accent-1); }
        .themed-accent-2-border { border-color: var(--c-accent-2); }
        .themed-highlight { color: var(--c-highlight); }
        .themed-highlight-bg { background-color: var(--c-highlight); }
        .themed-dark-bg { background-color: var(--dark-bg); }
        .themed-dark-text { color: var(--dark-text); }
        .themed-dark-highlight { color: var(--dark-highlight); }
        .themed-dark-accent-1 { color: var(--dark-accent-1); }
        .themed-dark-accent-2-border { border-color: var(--dark-accent-2); }
        
        .hero-link {
            border-color: var(--dark-accent-1); 
            color: var(--dark-accent-1); 
            backdrop-filter: blur(5px);
        }
        .hero-link:hover {
            background-color: rgba(166, 124, 82, 0.1);
        }

        .subscribe-input {
            background-color: transparent;
            border-color: var(--c-accent-2);
            color: var(--c-text);
            --tw-ring-color: var(--c-accent-1);
        }

        .modal-header-btn {
            color: var(--c-highlight);
        }
        .modal-header-btn:hover {
            opacity: 1 !important;
        }
        .modal-header-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal-like-count {
            color: var(--c-highlight);
        }

        .modal-reflections-title {
            color: var(--c-accent-1);
        }

        .modal-comment-prompt button {
            color: var(--c-accent-1);
        }

        .modal-comment-textarea {
            background-color: var(--c-bg); 
            border-color: var(--c-accent-2); 
            color: var(--c-text); 
            --tw-ring-color: var(--c-accent-1);
        }

        .modal-comment-post-btn {
            background-color: var(--c-accent-1); 
            color: var(--c-bg);
        }
        
        .modal-comment-item {
            border-color: var(--c-accent-2);
        }
        
        .modal-comment-error {
            color: var(--c-highlight);
        }
        
        .subscribe-thanks {
            color: var(--c-highlight);
        }

        .theme-toggle-btn {
            background-color: var(--c-accent-2); 
            color: var(--c-text);
        }
        
    </style>
</head>
<body class="font-body">

    <!-- STICKY NAV -->
    <nav id="top-nav" class="fixed top-0 left-0 right-0 py-4 px-4 md:px-8 z-40">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <a href="#about" class="font-headline text-2xl font-bold themed-accent-1">Timeless Whispers</a>
            <div class="flex items-center gap-4 md:gap-6">
                <a href="#journal" class="font-body text-sm hover:text-[var(--c-highlight)] transition-colors">Journal</a>
                <a href="#gallery" class="font-body text-sm hover:text-[var(--c-highlight)] transition-colors">Gallery</a>
                <a href="#connect" class="font-body text-sm hover:text-[var(--c-highlight)] transition-colors">Connect</a>
                <!-- Admin link now points to a separate page -->
                <a id="admin-link" href="admin.html" class="font-body text-sm hover:text-[var(--c-highlight)] transition-colors hidden">Admin Panel</a>
                
                <!-- Auth UI simplified, login/logout buttons removed -->
                <div id="nav-auth" class="flex items-center gap-2 md:gap-4 pl-2 md:pl-4 border-l themed-accent-2-border">
                    <span id="user-info" class="text-sm hidden">
                        <span id="user-name" class="font-bold"></span>
                    </span>
                    <button id="google-signin-btn" class="font-body text-sm font-bold themed-accent-1 hover:themed-highlight transition-colors">
                        Sign In
                    </button>
                    <button id="signout-btn" class="font-body text-sm opacity-70 hover:opacity-100 transition-opacity hidden">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main>
        
        <!-- ABOUT ME (CINEMATIC HERO) -->
        <section id="about" class="min-h-screen flex items-center justify-center relative p-8 text-center text-white" style="background-image: url('https://images.unsplash.com/photo-1455390582262-044cdead277a?q=80&w=1973&auto=format=fit=crop'); background-size: cover; background-position: center; background-color: var(--dark-bg);">
            <div class="absolute inset-0 bg-black/60 z-10"></div>
            <div class="relative z-20 max-w-3xl mx-auto px-4 fade-in-up">
                 <h2 class="font-headline text-5xl md:text-7xl font-bold themed-dark-highlight">This is me, unfiltered.</h2>
                 <p class="mt-6 opacity-90 leading-relaxed text-lg md:text-xl">I‚Äôm Max‚Äîa wordsmith on a mission to turn life into poetry! Every line I write is fueled by love, heartbreak, and the crazy twists and turns of this beautiful chaos we call life.<br><br>I don‚Äôt just write poems; I create moments, feelings, and stories that stick with you. Whether it‚Äôs finding light in the dark or chasing dreams that set your soul on fire, my poetry is here to vibe with yours.<br><br>Dive in, feel the rhythm, and let‚Äôs turn life into poetry together!</p>
                 <a href="#gallery" class="hero-link inline-block mt-8 font-bold text-lg transition-colors duration-300 border-2 py-3 px-6 rounded-full">
                    [ Read the Collection ]
                 </a>
            </div>
        </section>

        <!-- POET'S JOURNAL (INTERLUDE) -->
        <section id="journal" class="min-h-screen py-20 px-4 md:px-8 flex items-center justify-center themed-dark-bg themed-dark-text">
            <div class="max-w-3xl mx-auto text-center fade-in-up">
                <h2 class="font-headline text-4xl font-bold themed-dark-highlight">Poet‚Äôs Journal</h2>
                <p class="mt-2 mb-12 opacity-70">Short writings, reflections, or the stories behind the poems.</p>
                <div class="text-left grid grid-cols-1 gap-12">
                    <div class="border-l-2 pl-6 themed-dark-accent-2-border">
                        <h3 class="font-headline text-2xl font-bold themed-dark-accent-1">An Open Book</h3>
                        <p class="mt-2 opacity-80 font-writing text-lg">I write for everyone. There are no "letters I never sent" here, no hidden diaries. My work is an open book, a conversation with the world. Each poem is a piece of my soul, offered freely, hoping to find a connection in yours.</p>
                    </div>
                    <div class*="border-l-2 pl-6 themed-dark-accent-2-border">
                        <h3 class="font-headline text-2xl font-bold themed-dark-accent-1">On Finding Hope in Chaos</h3>
                        <p class="mt-2 opacity-80 font-writing text-lg">It's easy to write about storms, but what about the first ray of light that breaks through? This is a reflection on capturing that fleeting moment of optimism when all seems lost...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- EMOTION GALLERY -->
        <section id="gallery" class="min-h-screen py-20 px-4 md:px-8 flex items-center">
            <div class="max-w-6xl w-full mx-auto">
                <h2 class="font-headline text-4xl text-center font-bold themed-highlight">Read what your heart needs.</h2>
                <div id="emotion-filters" class="flex flex-wrap justify-center gap-2 md:gap-4 my-8">
                    <!-- Filters will be injected here -->
                </div>
                <div id="poems-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Poem cards will be injected here -->
                </div>
            </div>
        </section>

        <!-- CONNECT / SUBSCRIBE -->
        <section id="connect" class="min-h-screen py-20 text-center px-4 flex items-center justify-center bg-black/5 dark:bg-white/5">
            <div class="w-full">
                <h2 class="font-headline text-3xl font-bold themed-accent-1">Join the Circle</h2>
                <p class="mt-2 mb-6 opacity-70">Receive new poems and journal entries directly.</p>
                <div class="max-w-sm mx-auto">
                    <form id="subscribe-form" class="flex gap-2">
                        <input id="email" type="email" placeholder="Your email address" required class="subscribe-input w-full p-3 rounded-full border-2 focus:ring-2 outline-none transition-shadow">
                        <button type="button" onclick="subscribe()" class="font-bold py-3 px-6 rounded-full shadow-lg hover:opacity-90 transition-all themed-accent-1-bg themed-bg">Subscribe</button>
                    </form>
                    <div id="subscribe-thanks" class="hidden mt-4 text-lg subscribe-thanks">
                        Thank you for subscribing!
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <footer class="py-12 text-center border-t themed-accent-2-border">
        <div class="flex justify-center gap-6 mb-4">
            <a href="#about" class="hover:text-[var(--c-highlight)] transition-colors">About</a>
            <a href="#journal" class="hover:text-[var(--c-highlight)] transition-colors">Journal</a>
            <a href="#gallery" class="hover:text-[var(--c-highlight)] transition-colors">Poems</a>
            <a href="#connect" class="hover:text-[var(--c-highlight)] transition-colors">Contact</a>
        </div>
        <p class="italic opacity-60">‚ÄúSome poems aren't just read ‚Äî they're felt.‚Äù</p>
        <p class="text-sm mt-4 opacity-50">&copy; 2025 Timeless Whispers. All Rights Reserved.</p>
    </footer>

    <!-- QUICK PREVIEW MODAL -->
    <div id="quick-preview-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-[60] opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="modal-content w-full max-w-2xl max-h-[80vh] overflow-y-auto p-8 md:p-12 rounded-lg shadow-2xl relative z-[70]">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-2xl opacity-50 hover:opacity-100 transition-opacity">&times;</button>
            <div id="modal-poem-content"></div>
        </div>
    </div>
    
    <!-- THEME TOGGLE BUTTON -->
    <button id="theme-toggle" class="theme-toggle-btn fixed top-6 right-6 w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg z-50">
        <!-- Icon will be injected here -->
    </button>
    
</body>
</html>