<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Timeless Whispers</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Raleway:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFirestore, collection, addDoc, getDocs, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // PASTE YOUR FIREBASE CONFIG HERE
      const firebaseConfig = {
        apiKey: "AIzaSyCsufbKfJcNZ40aDXDNXgHI-QphkFmXi-0",
        authDomain: "timelesswhispers-37f98.firebaseapp.com",
        projectId: "timelesswhispers-37f98",
        storageBucket: "timelesswhispers-37f98.firebasestorage.app",
        messagingSenderId: "632234683017",
        appId: "1:632234683017:web:04f44be51fa2f88075b458",
        measurementId: "G-PLN3R3YSCX"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const appId = firebaseConfig.appId;
      
      // This is the EXACT path your main site is reading from
      const poemsColRef = collection(db, "artifacts", appId, "public", "data", "poems");

      document.addEventListener('DOMContentLoaded', () => {
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const adminPanel = document.getElementById('admin-panel');
        const loginScreen = document.getElementById('login-screen');
        const poemForm = document.getElementById('poem-form');
        const statusMessage = document.getElementById('status-message');
        const loadingIndicator = document.getElementById('loading-indicator');

        const provider = new GoogleAuthProvider();

        // --- Auth Functions ---
        loginBtn.addEventListener('click', () => {
          signInWithPopup(auth, provider).catch(err => console.error(err));
        });

        logoutBtn.addEventListener('click', () => {
          signOut(auth);
        });

        onAuthStateChanged(auth, (user) => {
          if (user) {
            // User is signed in
            loginScreen.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            document.getElementById('admin-name').textContent = user.displayName;
          } else {
            // User is signed out
            loginScreen.classList.remove('hidden');
            adminPanel.classList.add('hidden');
          }
        });

        // --- Form Submission ---
        poemForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const title = document.getElementById('poem-title').value;
          const content = document.getElementById('poem-content').value;
          const emotion = document.getElementById('poem-emotion').value;
          const submitBtn = document.getElementById('submit-btn');

          if (!title || !content || !emotion) {
            showStatus("Please fill out all fields.", true);
            return;
          }

          submitBtn.disabled = true;
          loadingIndicator.classList.remove('hidden');
          showStatus("Submitting...", false);

          try {
            // 1. Get all existing poems to find the highest ID
            const q = query(poemsColRef);
            const snapshot = await getDocs(q);
            let highestId = 0;
            snapshot.forEach(doc => {
              const poemId = doc.data().id;
              if (poemId && poemId > highestId) {
                highestId = poemId;
              }
            });
            
            // 2. Create the new poem object with the next ID
            const newPoem = {
              title: title,
              content: content,
              emotion: emotion,
              id: highestId + 1 // Ensure new poems sort to the end
            };

            // 3. Add the new poem to the correct collection
            const docRef = await addDoc(poemsColRef, newPoem);
            
            console.log("Poem submitted with ID: ", docRef.id);
            showStatus("Poem submitted successfully!", false);
            poemForm.reset();

          } catch (error) {
            console.error("Error adding poem: ", error);
            showStatus(`Error: ${error.message}`, true);
          } finally {
            submitBtn.disabled = false;
            loadingIndicator.classList.add('hidden');
          }
        });

        function showStatus(message, isError = false) {
          statusMessage.textContent = message;
          statusMessage.className = `text-sm ${isError ? 'text-red-500' : 'text-green-500'}`;
          statusMessage.classList.remove('hidden');
        }
      });
    </script>
    <style>
        .font-headline { font-family: 'Playfair Display', serif; }
        .font-body { font-family: 'Raleway', sans-serif; }
    </style>
</head>
<body class="font-body bg-gray-100 text-gray-800 min-h-screen">
    
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="text-center p-8 bg-white rounded-lg shadow-md">
            <h1 class="font-headline text-3xl text-gray-900">Timeless Whispers</h1>
            <h2 class="font-body text-xl text-gray-600 mb-6">Admin Panel</h2>
            <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition-colors">
                Sign In With Google
            </button>
        </div>
    </div>

    <!-- Admin Panel (Hidden by default) -->
    <div id="admin-panel" class="hidden">
        <nav class="bg-white shadow-md">
            <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="font-headline text-xl text-gray-900">Admin Panel</h1>
                <div>
                    <span class="text-sm mr-4">Welcome, <span id="admin-name" class="font-bold"></span></span>
                    <button id="logout-btn" class="text-sm text-blue-600 hover:underline">Sign Out</button>
                </div>
            </div>
        </nav>

        <main class="max-w-4xl mx-auto p-4 md:p-8">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow-md">
                <h2 class="font-headline text-2xl text-gray-900 mb-6">Add a New Poem</h2>
                
                <form id="poem-form" class="space-y-4">
                    <!-- Title -->
                    <div>
                        <label for="poem-title" class="block text-sm font-medium text-gray-700">Title</label>
                        <input type="text" id="poem-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                    </div>

                    <!-- Category -->
                    <div>
                        <label for="poem-emotion" class="block text-sm font-medium text-gray-700">Category (Emotion)</label>
                        <select id="poem-emotion" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                            <option value="">Select a category...</option>
                            <option value="Love">Love</option>
                            <option value="Loss">Loss</option>
                            <option value="Hope">Hope</option>
                            <option value="Healing">Healing</option>
                            <option value="Chaos">Chaos</option>
                            <option value="Silent Nights">Silent Nights</option>
                            <option value="Red Verse">Red Verse</option>
                        </select>
                    </div>

                    <!-- Content -->
                    <div>
                        <label for="poem-content" class="block text-sm font-medium text-gray-700">Content</label>
                        <textarea id="poem-content" rows="15" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required></textarea>
                        <p class="text-xs text-gray-500 mt-1">Line breaks will be preserved.</p>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex items-center gap-4">
                        <button id="submit-btn" type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-full transition-colors disabled:opacity-50">
                            Submit Poem
                        </button>
                        <svg id="loading-indicator" class="hidden animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="status-message" class="text-sm hidden"></span>
                    </div>
                </form>
            </div>
        </main>
    </div>

</body>
</html>